{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Hi,\r\n\r\nwe are currently facing an interesting issue downstream in `setuptools` with an imported, incompatible Cython install that might exist in a user's environment, e.g. while working with python virtual environments, conda or spack: https://github.com/pypa/setuptools/issues/1229#issuecomment-349644856\r\n\r\nThe main issue comes down to the fact that a downstream \"optional usage of Cython\" in the form of\r\n\r\n```python\r\ntry:\r\n    # Attempt to use Cython for building extensions, if available\r\n    from Cython.Distutils.build_ext import build_ext as _build_ext\r\nexcept ImportError:\r\n    # some fallback such as\r\n    _build_ext = _du_build_ext\r\n```\r\n\r\nwill not catch any errors that can occur when using a compiled library such as Cython. Exemplary errors can look like\r\n\r\n```\r\nfailed to import Cython: /home/axel/.local/lib/python2.7/site-packages/Cython/Compiler/Scanning.so: undefined symbol: PyUnicodeUCS4_DecodeUTF8\r\nUnexpected error: <class 'distutils.errors.DistutilsPlatformError'>\r\n```\r\n\r\nin the case of symbol mismatches between currently used virtual environment, system or user libraries. Unfortunately, such errors are not triggered on `import` but as soon as the imported functionality is used later on. (A full reproducer is posted [here](https://github.com/pypa/setuptools/issues/1229#issuecomment-349732124) including a Dockerfile.)\r\n\r\nWe were wondering if there already is or if one could add a short, side-effect free \"test\" interface that one could call [directly after the import in the same `try` scope](https://github.com/pypa/setuptools/issues/1229#issuecomment-349973536) in order to reliably trigger and catch incompatibly imported Cython installs?\r\n\r\nAny feedback or suggestions are very welcome!",
    "closed_at": "2018-05-27T08:03:46Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Three things:\r\n- It's intentional that importing the `build_ext` module does not import the compiler.\r\n- It would be better to import `new_build_ext` instead of `build_ext`. It's much closer to what people would expect as a default behaviour these days, since it calls `cythonize()` internally.\r\n- You can just import the compiler explicitly to detect errors like the one you mentioned. Just import `Cython.Compiler.Main` or `from Cython.Build import cythonize` or something like that. Drawback is, obviously, that all of Cython gets imported early even if it's not used at all.",
            "created_at": "2018-01-19T19:52:22Z",
            "html_url": "https://github.com/cython/cython/issues/2061#issuecomment-359071601",
            "id": 359071601,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2061",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1OTA3MTYwMQ==",
            "updated_at": "2018-01-19T19:52:22Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/359071601",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "@jaraco would one of the above solutions be suitable for you, downstream in setuptools?",
            "created_at": "2018-01-20T14:57:01Z",
            "html_url": "https://github.com/cython/cython/issues/2061#issuecomment-359177131",
            "id": 359177131,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2061",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1OTE3NzEzMQ==",
            "updated_at": "2018-01-20T14:57:01Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/359177131",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/1353258?v=4",
                "events_url": "https://api.github.com/users/ax3l/events{/privacy}",
                "followers_url": "https://api.github.com/users/ax3l/followers",
                "following_url": "https://api.github.com/users/ax3l/following{/other_user}",
                "gists_url": "https://api.github.com/users/ax3l/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ax3l",
                "id": 1353258,
                "login": "ax3l",
                "node_id": "MDQ6VXNlcjEzNTMyNTg=",
                "organizations_url": "https://api.github.com/users/ax3l/orgs",
                "received_events_url": "https://api.github.com/users/ax3l/received_events",
                "repos_url": "https://api.github.com/users/ax3l/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ax3l/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ax3l/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ax3l"
            }
        },
        {
            "author_association": "NONE",
            "body": "The third option looks like it may be the officially-supported way to detect if the compiler is available. Probably just `__import__('Cython.Compiler.Main')` with a comment explaining why.",
            "created_at": "2018-01-20T17:21:44Z",
            "html_url": "https://github.com/cython/cython/issues/2061#issuecomment-359187140",
            "id": 359187140,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2061",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1OTE4NzE0MA==",
            "updated_at": "2018-01-20T17:21:44Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/359187140",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/308610?v=4",
                "events_url": "https://api.github.com/users/jaraco/events{/privacy}",
                "followers_url": "https://api.github.com/users/jaraco/followers",
                "following_url": "https://api.github.com/users/jaraco/following{/other_user}",
                "gists_url": "https://api.github.com/users/jaraco/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jaraco",
                "id": 308610,
                "login": "jaraco",
                "node_id": "MDQ6VXNlcjMwODYxMA==",
                "organizations_url": "https://api.github.com/users/jaraco/orgs",
                "received_events_url": "https://api.github.com/users/jaraco/received_events",
                "repos_url": "https://api.github.com/users/jaraco/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jaraco/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jaraco/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jaraco"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Closing, as I think an explicit import solves this issue.",
            "created_at": "2018-05-27T08:03:46Z",
            "html_url": "https://github.com/cython/cython/issues/2061#issuecomment-392313231",
            "id": 392313231,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2061",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MjMxMzIzMQ==",
            "updated_at": "2018-05-27T08:03:46Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/392313231",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2061/comments",
    "created_at": "2018-01-08T17:02:04Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/308610?v=4",
                "events_url": "https://api.github.com/users/jaraco/events{/privacy}",
                "followers_url": "https://api.github.com/users/jaraco/followers",
                "following_url": "https://api.github.com/users/jaraco/following{/other_user}",
                "gists_url": "https://api.github.com/users/jaraco/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jaraco",
                "id": 308610,
                "login": "jaraco",
                "node_id": "MDQ6VXNlcjMwODYxMA==",
                "organizations_url": "https://api.github.com/users/jaraco/orgs",
                "received_events_url": "https://api.github.com/users/jaraco/received_events",
                "repos_url": "https://api.github.com/users/jaraco/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jaraco/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jaraco/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jaraco"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-01-20T14:57:01Z",
            "event": "mentioned",
            "id": 1433724752,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MTQzMzcyNDc1Mg==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1433724752"
        },
        {
            "actor": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/308610?v=4",
                "events_url": "https://api.github.com/users/jaraco/events{/privacy}",
                "followers_url": "https://api.github.com/users/jaraco/followers",
                "following_url": "https://api.github.com/users/jaraco/following{/other_user}",
                "gists_url": "https://api.github.com/users/jaraco/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jaraco",
                "id": 308610,
                "login": "jaraco",
                "node_id": "MDQ6VXNlcjMwODYxMA==",
                "organizations_url": "https://api.github.com/users/jaraco/orgs",
                "received_events_url": "https://api.github.com/users/jaraco/received_events",
                "repos_url": "https://api.github.com/users/jaraco/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jaraco/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jaraco/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jaraco"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-01-20T14:57:01Z",
            "event": "subscribed",
            "id": 1433724753,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDE0MzM3MjQ3NTM=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1433724753"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-05-27T08:03:46Z",
            "event": "closed",
            "id": 1648137212,
            "node_id": "MDExOkNsb3NlZEV2ZW50MTY0ODEzNzIxMg==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1648137212"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2061/events",
    "html_url": "https://github.com/cython/cython/issues/2061",
    "id": 286813476,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2061/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUyODY4MTM0NzY=",
    "number": 2061,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Quick Test Routine After Import",
    "updated_at": "2018-05-27T08:03:46Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2061",
    "user": {
        "avatar_url": "https://avatars3.githubusercontent.com/u/1353258?v=4",
        "events_url": "https://api.github.com/users/ax3l/events{/privacy}",
        "followers_url": "https://api.github.com/users/ax3l/followers",
        "following_url": "https://api.github.com/users/ax3l/following{/other_user}",
        "gists_url": "https://api.github.com/users/ax3l/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ax3l",
        "id": 1353258,
        "login": "ax3l",
        "node_id": "MDQ6VXNlcjEzNTMyNTg=",
        "organizations_url": "https://api.github.com/users/ax3l/orgs",
        "received_events_url": "https://api.github.com/users/ax3l/received_events",
        "repos_url": "https://api.github.com/users/ax3l/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ax3l/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ax3l/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ax3l"
    }
}