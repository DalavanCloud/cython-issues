{
    "assignee": null,
    "assignees": [],
    "body": "I can't build and compile a C++ extension in Cython:\r\n\r\nThe extension is `mapping.pyx`\r\n\r\n```\r\n# distutils: language=c++\r\n\r\nfrom libc.stdint cimport uint32_t\r\n\r\nfrom collections import namedtuple\r\n\r\n\r\nPosition = namedtuple(\"Position\", [\"pos\", \"ref\", \"p_a\", \"p_c\", \"p_g\", \"p_t\"])\r\n\r\n\r\ncdef extern from \"mapping.h\":\r\n    ctypedef struct SNV:\r\n        char ref\r\n        float p_a\r\n        float p_c\r\n        float p_g\r\n        float p_t\r\n\r\n    cdef cppclass GenomeMap:\r\n        GenomeMap(uint32_t size) except +\r\n        void add(uint32_t position, SNV snv)\r\n        float get(uint32_t position, char ref, char alt) except +\r\n\r\n\r\ncdef class PyGenomeMap:\r\n    cdef GenomeMap* cpp_genomemap\r\n\r\n    def __cinit__(self, uint32_t size):\r\n        self.cpp_genomemap = new GenomeMap(size)\r\n\r\n    # def __init__(self, positions=None):\r\n    #     \"\"\"\r\n    #     :type positions: Position\r\n    #     \"\"\"\r\n    #     for position in positions or []:\r\n    #         self.add(position)\r\n\r\n    def __dealloc__(self):\r\n        del self.cpp_genomemap\r\n\r\n    def add(self, position):\r\n        pos, ref, p_a, p_c, p_g, p_t = position\r\n        cdef SNV snv;\r\n        snv.ref = ord(ref)\r\n        snv.p_a = p_a\r\n        snv.p_c = p_c\r\n        snv.p_g = p_g\r\n        snv.p_t = p_t\r\n        (self.cpp_genomemap[0]).add(pos, snv)\r\n\r\n    def get(self, uint32_t position, str ref, str alt):\r\n        return (self.cpp_genomemap[0]).get(position, ord(ref), ord(alt))\r\n```\r\n\r\nHere is my `setup.py`\r\n\r\n    from distutils.core import setup\r\n    import os\r\n    \r\n    from Cython.Build import cythonize\r\n    \r\n    os.environ['CFLAGS'] = '-O3 -Wall -std=c++11'\r\n    \r\n    setup(\r\n        ext_modules=cythonize(\"mapping.pyx\",\r\n                              sources=[\"mapping.h\", \"sparsepp.h\"],\r\n                              language=\"c++\")\r\n    )\r\n\r\nWhen I run `python setup.py` or `python setup.py build_ext --inplace` in the shell I get this\r\n\r\n    /Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Distutils/old_build_ext.py:30: UserWarning: Cython.Distutils.old_build_ext does not properly handle dependencies and is deprecated.\r\n      \"Cython.Distutils.old_build_ext does not properly handle dependencies \"\r\n    /Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Main.py:562: UserWarning: got unknown compilation option, please remove: sources\r\n      warnings.warn(message)\r\n    Please put \"# distutils: language=c++\" in your .pyx or .pxd file(s)\r\n    Compiling mapping.pyx because it changed.\r\n    [1/1] Cythonizing mapping.pyx\r\n    Traceback (most recent call last):\r\n      File \"setup.py\", line 11, in <module>\r\n        language=\"c++\")\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Build/Dependencies.py\", line 925, in cythonize\r\n        cythonize_one(*args)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Build/Dependencies.py\", line 1030, in cythonize_one\r\n        result = compile([pyx_file], options)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Main.py\", line 687, in compile\r\n        return compile_multiple(source, options)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Main.py\", line 665, in compile_multiple\r\n        result = run_pipeline(source, options, context=context)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Main.py\", line 495, in run_pipeline\r\n        err, enddata = Pipeline.run_pipeline(pipeline, source)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Pipeline.py\", line 340, in run_pipeline\r\n        data = phase(data)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Pipeline.py\", line 53, in generate_pyx_code_stage\r\n        module_node.process_implementation(options, result)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/ModuleNode.py\", line 137, in process_implementation\r\n        self.generate_c_code(env, options, result)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/ModuleNode.py\", line 365, in generate_c_code\r\n        self.body.generate_function_definitions(env, code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 436, in generate_function_definitions\r\n        stat.generate_function_definitions(env, code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 4637, in generate_function_definitions\r\n        self.body.generate_function_definitions(self.scope, code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 436, in generate_function_definitions\r\n        stat.generate_function_definitions(env, code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 3060, in generate_function_definitions\r\n        FuncDefNode.generate_function_definitions(self, env, code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 1926, in generate_function_definitions\r\n        self.generate_function_body(env, code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 1693, in generate_function_body\r\n        self.body.generate_execution_code(code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 442, in generate_execution_code\r\n        stat.generate_execution_code(code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/Nodes.py\", line 5579, in generate_execution_code\r\n        self.value.generate_evaluation_code(code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/ExprNodes.py\", line 705, in generate_evaluation_code\r\n        self.generate_result_code(code)\r\n      File \"/Users/ilia/.venvs/py3/lib/python3.5/site-packages/Cython/Compiler/ExprNodes.py\", line 12531, in generate_result_code\r\n        self.arg.type.to_py_call_code(\r\n    AttributeError: 'ErrorType' object has no attribute 'to_py_call_code'\r\n\r\nThe only relevant link I've found is http://stackoverflow.com/questions/13383567/cython-attributeerror-module-object-has-no-attribute-declare but it covers a different situation. Any ideas? \r\n\r\nP.S.\r\n\r\nThe C++ library I'm wrapping compiles and works fine.",
    "closed_at": "2016-12-23T21:31:31Z",
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1564/comments",
    "created_at": "2016-12-23T20:44:29Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6906110?v=3",
                "events_url": "https://api.github.com/users/grayfall/events{/privacy}",
                "followers_url": "https://api.github.com/users/grayfall/followers",
                "following_url": "https://api.github.com/users/grayfall/following{/other_user}",
                "gists_url": "https://api.github.com/users/grayfall/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/grayfall",
                "id": 6906110,
                "login": "grayfall",
                "organizations_url": "https://api.github.com/users/grayfall/orgs",
                "received_events_url": "https://api.github.com/users/grayfall/received_events",
                "repos_url": "https://api.github.com/users/grayfall/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/grayfall/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/grayfall/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/grayfall"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2016-12-23T21:31:31Z",
            "event": "closed",
            "id": 904389476,
            "url": "https://api.github.com/repos/cython/cython/issues/events/904389476"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1564/events",
    "html_url": "https://github.com/cython/cython/issues/1564",
    "id": 197424489,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1564/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1564,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "AttributeError: 'ErrorType' object has no attribute 'to_py_call_code'",
    "updated_at": "2016-12-23T21:31:52Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1564",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/6906110?v=3",
        "events_url": "https://api.github.com/users/grayfall/events{/privacy}",
        "followers_url": "https://api.github.com/users/grayfall/followers",
        "following_url": "https://api.github.com/users/grayfall/following{/other_user}",
        "gists_url": "https://api.github.com/users/grayfall/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/grayfall",
        "id": 6906110,
        "login": "grayfall",
        "organizations_url": "https://api.github.com/users/grayfall/orgs",
        "received_events_url": "https://api.github.com/users/grayfall/received_events",
        "repos_url": "https://api.github.com/users/grayfall/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/grayfall/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/grayfall/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/grayfall"
    }
}