{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Test program:\r\n\r\n```\r\ndef run():\r\n  test_list = ['a']\r\n  test_list_len = len(test_list)\r\n  div1 = 1/(test_list_len + 1)\r\n  div2 = 1/(len(test_list) + 1)\r\n  print(div1)\r\n  print(div2)\r\n```\r\n\r\nResults of test.run() in Python 3.5.2, it's clear the results of `div1` and `div2` are not the same:\r\n```\r\n0.5\r\n0\r\n```\r\n\r\nHere is the C code generated for each line:\r\n```\r\n  /* \"test.py\":4\r\n *   test_list = ['a']\r\n *   test_list_len = len(test_list)\r\n *   div1 = 1/(test_list_len + 1)             # <<<<<<<<<<<<<<\r\n *   div2 = 1/(len(test_list) + 1)\r\n *   print(div1)\r\n */\r\n  __pyx_t_1 = __Pyx_PyInt_AddObjC(__pyx_v_test_list_len, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 4, __pyx_L1_error)\r\n  __Pyx_GOTREF(__pyx_t_1);\r\n  __pyx_t_3 = __Pyx_PyNumber_Divide(__pyx_int_1, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 4, __pyx_L1_error)\r\n  __Pyx_GOTREF(__pyx_t_3);\r\n  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;\r\n  __pyx_v_div1 = __pyx_t_3;\r\n  __pyx_t_3 = 0;\r\n```\r\n\r\n```\r\n  /* \"test.py\":5\r\n *   test_list_len = len(test_list)\r\n *   div1 = 1/(test_list_len + 1)\r\n *   div2 = 1/(len(test_list) + 1)             # <<<<<<<<<<<<<<\r\n *   print(div1)\r\n *   print(div2)\r\n */\r\n  __pyx_t_2 = PyList_GET_SIZE(__pyx_v_test_list); if (unlikely(__pyx_t_2 == ((Py_ssize_t)-1))) __PYX_ERR(0, 5, __pyx_L1_error)\r\n  __pyx_t_4 = (__pyx_t_2 + 1);\r\n  if (unlikely(__pyx_t_4 == 0)) {\r\n    PyErr_SetString(PyExc_ZeroDivisionError, \"integer division or modulo by zero\");\r\n    __PYX_ERR(0, 5, __pyx_L1_error)\r\n  }\r\n  else if (sizeof(Py_ssize_t) == sizeof(long) && (!(((Py_ssize_t)-1) > 0)) && unlikely(__pyx_t_4 == (Py_ssize_t)-1)  && unlikely(UNARY_NEG_WOULD_OVERFL$\r\n    PyErr_SetString(PyExc_OverflowError, \"value too large to perform division\");\r\n    __PYX_ERR(0, 5, __pyx_L1_error)\r\n  }\r\n  __pyx_v_div2 = __Pyx_div_Py_ssize_t(1, __pyx_t_4);\r\n```\r\n\r\nI can see that `__Pyx_PyNumber_Divide` changes based on the detected Python runtime, while `__Pyx_div_Py_ssize_t` is the same in either runtime:\r\n\r\n```\r\nstatic CYTHON_INLINE Py_ssize_t __Pyx_div_Py_ssize_t(Py_ssize_t a, Py_ssize_t b) {\r\n    Py_ssize_t q = a / b;\r\n    Py_ssize_t r = a - q*b;\r\n    q -= ((r != 0) & ((r ^ b) < 0));\r\n    return q;\r\n}\r\n```\r\n\r\nI plan to set `'language_level': 3` in my compiler directives, because this will suit my needs, but I was pretty surprised by the behavior. I expected both lines to use int division or float division, but not a mixture!",
    "closed_at": "2018-11-23T21:44:01Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Related, the behavior of `div0 = 1 / 2`:\r\n\r\n```\r\n  /* \"test.py\":3\r\n * def run():\r\n *   len1 = len([1, 2])\r\n *   div0 = 1 / 2             # <<<<<<<<<<<<<<\r\n *   div1 = 1 / len1\r\n *   div2 = 1 / len([1, 2])\r\n */\r\n  __pyx_v_div0 = 0;\r\n```\r\nSo the generated code is optimized to 0, which is unexpected with Python 3.",
            "created_at": "2018-11-21T23:57:34Z",
            "html_url": "https://github.com/cython/cython/issues/2728#issuecomment-440854528",
            "id": 440854528,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2728",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MDg1NDUyOA==",
            "updated_at": "2018-11-21T23:57:34Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/440854528",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/8216091?v=4",
                "events_url": "https://api.github.com/users/kadler15/events{/privacy}",
                "followers_url": "https://api.github.com/users/kadler15/followers",
                "following_url": "https://api.github.com/users/kadler15/following{/other_user}",
                "gists_url": "https://api.github.com/users/kadler15/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/kadler15",
                "id": 8216091,
                "login": "kadler15",
                "node_id": "MDQ6VXNlcjgyMTYwOTE=",
                "organizations_url": "https://api.github.com/users/kadler15/orgs",
                "received_events_url": "https://api.github.com/users/kadler15/received_events",
                "repos_url": "https://api.github.com/users/kadler15/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/kadler15/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kadler15/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/kadler15"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "This is due to type inference.\r\n```\r\ndef run():\r\n  test_list = ['a']\r\n  test_list_len = len(test_list)   # -> result is `Py_ssize_t`\r\n  div1 = 1/(test_list_len + 1)    # -> representing `test_list_len` as C integer is unsafe (can overflow)\r\n  div2 = 1/(len(test_list) + 1)    # -> result of `len()` is `Py_ssize_t`, expression is evaluated in C\r\n  print(div1)\r\n  print(div2)\r\n```\r\nIf you typed `test_list_len` as `Py_ssize_t`, you would get the same (C-ish) result for both. Cython's (safe) type inference decides that it cannot safely type `test_list_len` as C integer and therefore calculates it in Python space, where the result depends on the runtime Python version.\r\n\r\nDo I understand correctly that you did not yet enable 'language_level=3` in the example above?",
            "created_at": "2018-11-23T21:37:55Z",
            "html_url": "https://github.com/cython/cython/issues/2728#issuecomment-441320801",
            "id": 441320801,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2728",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTMyMDgwMQ==",
            "updated_at": "2018-11-23T21:37:55Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/441320801",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "When I try it (with the latest master and `language_level=3`), I get a float result for `div2`, as expected. Closing as not a bug.",
            "created_at": "2018-11-23T21:44:01Z",
            "html_url": "https://github.com/cython/cython/issues/2728#issuecomment-441321326",
            "id": 441321326,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2728",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTMyMTMyNg==",
            "updated_at": "2018-11-23T21:44:01Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/441321326",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "Thanks for your response. You're correct that I had not enabled `language_level=3` in the example above. With `language_level=3` I get a float result for both `div1` and `div2`. With `language_level=2` and Python 3 runtime, I get a float for `div1` and what looks like an int for `div2`.",
            "created_at": "2018-11-27T00:41:36Z",
            "html_url": "https://github.com/cython/cython/issues/2728#issuecomment-441854346",
            "id": 441854346,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2728",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ0MTg1NDM0Ng==",
            "updated_at": "2018-11-27T00:41:51Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/441854346",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/8216091?v=4",
                "events_url": "https://api.github.com/users/kadler15/events{/privacy}",
                "followers_url": "https://api.github.com/users/kadler15/followers",
                "following_url": "https://api.github.com/users/kadler15/following{/other_user}",
                "gists_url": "https://api.github.com/users/kadler15/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/kadler15",
                "id": 8216091,
                "login": "kadler15",
                "node_id": "MDQ6VXNlcjgyMTYwOTE=",
                "organizations_url": "https://api.github.com/users/kadler15/orgs",
                "received_events_url": "https://api.github.com/users/kadler15/received_events",
                "repos_url": "https://api.github.com/users/kadler15/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/kadler15/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kadler15/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/kadler15"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2728/comments",
    "created_at": "2018-11-21T22:56:45Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-11-23T21:43:58Z",
            "event": "labeled",
            "id": 1984736613,
            "label": {
                "color": "444444",
                "name": "R: worksforme"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE5ODQ3MzY2MTM=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1984736613"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-11-23T21:44:01Z",
            "event": "closed",
            "id": 1984736637,
            "node_id": "MDExOkNsb3NlZEV2ZW50MTk4NDczNjYzNw==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1984736637"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2728/events",
    "html_url": "https://github.com/cython/cython/issues/2728",
    "id": 383320161,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "id": 425556354,
            "name": "R: worksforme",
            "node_id": "MDU6TGFiZWw0MjU1NTYzNTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20worksforme"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2728/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzODMzMjAxNjE=",
    "number": 2728,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "With default language_level and Python 3 runtime: surprising size_t division results",
    "updated_at": "2018-11-27T00:41:51Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2728",
    "user": {
        "avatar_url": "https://avatars3.githubusercontent.com/u/8216091?v=4",
        "events_url": "https://api.github.com/users/kadler15/events{/privacy}",
        "followers_url": "https://api.github.com/users/kadler15/followers",
        "following_url": "https://api.github.com/users/kadler15/following{/other_user}",
        "gists_url": "https://api.github.com/users/kadler15/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/kadler15",
        "id": 8216091,
        "login": "kadler15",
        "node_id": "MDQ6VXNlcjgyMTYwOTE=",
        "organizations_url": "https://api.github.com/users/kadler15/orgs",
        "received_events_url": "https://api.github.com/users/kadler15/received_events",
        "repos_url": "https://api.github.com/users/kadler15/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/kadler15/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/kadler15/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/kadler15"
    }
}