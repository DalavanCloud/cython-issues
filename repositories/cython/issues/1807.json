{
    "assignee": null,
    "assignees": [],
    "body": "The Cython code `obj[i]` where `i` is a `cdef int` is translated to a call to `__Pyx_GetItemInt_Fast`.\r\n\r\nThis will use the *sequence protocol* to get `obj[i]`. More precisely, `Py_TYPE(obj)->tp_as_sequence->sq_item(obj, i)` will be called.\r\n\r\nHowever, Python always tries the *mapping protocol* first. Because of this, it can happen that `obj[i]` in Cython behaves differently from Python. There is nothing in the Python docs that says that the mapping and sequence protocols should agree, so this is a bug.\r\n\r\nSimple repro:\r\n```\r\ndef get(obj, int i):\r\n    return obj[i]\r\n\r\nclass D(dict):\r\n    pass \r\n```\r\n\r\nThis gives:\r\n```\r\n>>> d = D([(-1, \"hello\")]); d\r\n{-1: 'hello'}\r\n>>> d[-1]\r\n'hello' \r\n>>> get(d, -1)\r\nKeyError: 0\r\n```",
    "closed_at": null,
    "comment_data": [
        {
            "body": "I'm sure this was done because the sequence protocol accepts C integer indices (which makes it more efficient if the index is passed as a C integer), but I agree that this is a bug.",
            "created_at": "2017-08-07T12:24:23Z",
            "html_url": "https://github.com/cython/cython/issues/1807#issuecomment-320649385",
            "id": 320649385,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1807",
            "updated_at": "2017-08-07T12:24:23Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/320649385",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "IIRC many types won't have `tp_as_mapping` anyways so it can still be skipped over easily in that case.  But otherwise it should be checked first.",
            "created_at": "2017-08-07T17:47:03Z",
            "html_url": "https://github.com/cython/cython/issues/1807#issuecomment-320732228",
            "id": 320732228,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1807",
            "updated_at": "2017-08-07T17:47:03Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/320732228",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/676149?v=4",
                "events_url": "https://api.github.com/users/embray/events{/privacy}",
                "followers_url": "https://api.github.com/users/embray/followers",
                "following_url": "https://api.github.com/users/embray/following{/other_user}",
                "gists_url": "https://api.github.com/users/embray/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/embray",
                "id": 676149,
                "login": "embray",
                "organizations_url": "https://api.github.com/users/embray/orgs",
                "received_events_url": "https://api.github.com/users/embray/received_events",
                "repos_url": "https://api.github.com/users/embray/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/embray/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/embray/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/embray"
            }
        },
        {
            "body": "The main difference will be for Python (non-extension) types, since `__getitem__` is put both in the mapping protocol as well as the sequence protocol. That is also why `class D(dict): pass` behaves differently from a plain `dict`.",
            "created_at": "2017-08-08T07:54:01Z",
            "html_url": "https://github.com/cython/cython/issues/1807#issuecomment-320880169",
            "id": 320880169,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1807",
            "updated_at": "2017-08-08T07:54:01Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/320880169",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/3625785?v=4",
                "events_url": "https://api.github.com/users/jdemeyer/events{/privacy}",
                "followers_url": "https://api.github.com/users/jdemeyer/followers",
                "following_url": "https://api.github.com/users/jdemeyer/following{/other_user}",
                "gists_url": "https://api.github.com/users/jdemeyer/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jdemeyer",
                "id": 3625785,
                "login": "jdemeyer",
                "organizations_url": "https://api.github.com/users/jdemeyer/orgs",
                "received_events_url": "https://api.github.com/users/jdemeyer/received_events",
                "repos_url": "https://api.github.com/users/jdemeyer/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jdemeyer/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jdemeyer/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jdemeyer"
            }
        },
        {
            "body": "Well, yes, for classes with `__getitem__`  that's definitely true.",
            "created_at": "2017-08-08T09:42:17Z",
            "html_url": "https://github.com/cython/cython/issues/1807#issuecomment-320906181",
            "id": 320906181,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1807",
            "updated_at": "2017-08-08T09:42:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/320906181",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/676149?v=4",
                "events_url": "https://api.github.com/users/embray/events{/privacy}",
                "followers_url": "https://api.github.com/users/embray/followers",
                "following_url": "https://api.github.com/users/embray/following{/other_user}",
                "gists_url": "https://api.github.com/users/embray/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/embray",
                "id": 676149,
                "login": "embray",
                "organizations_url": "https://api.github.com/users/embray/orgs",
                "received_events_url": "https://api.github.com/users/embray/received_events",
                "repos_url": "https://api.github.com/users/embray/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/embray/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/embray/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/embray"
            }
        },
        {
            "body": "But types that use the mapping protocol will require Python conversion of the 'index' value anyway, whether it's called through the sequence or mapping protocol.\r\n\r\nThere's a tiny performance impact for types that only use the sequence protocol, because Cython would now have to check the mapping protocol first. As long as the work done inside of the getitem method is non-trivial, it won't make a difference, but getitem might actually be really trivial in many important sequence cases.\r\n\r\nI think the only thing we can do is: implement, then measure. Open for pull requests.",
            "created_at": "2017-08-08T10:03:10Z",
            "html_url": "https://github.com/cython/cython/issues/1807#issuecomment-320911274",
            "id": 320911274,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1807",
            "updated_at": "2017-08-08T10:03:10Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/320911274",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1807/comments",
    "created_at": "2017-08-07T12:19:22Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2017-08-07T12:24:45Z",
            "event": "labeled",
            "id": 1195305189,
            "label": {
                "color": "444444",
                "name": "Code Generation"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/1195305189"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2017-08-07T12:24:45Z",
            "event": "labeled",
            "id": 1195305192,
            "label": {
                "color": "444444",
                "name": "Python Semantics"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/1195305192"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1807/events",
    "html_url": "https://github.com/cython/cython/issues/1807",
    "id": 248393779,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "id": 425556330,
            "name": "Code Generation",
            "url": "https://api.github.com/repos/cython/cython/labels/Code%20Generation"
        },
        {
            "color": "444444",
            "default": false,
            "id": 425556315,
            "name": "Python Semantics",
            "url": "https://api.github.com/repos/cython/cython/labels/Python%20Semantics"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1807/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1807,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "__Pyx_GetItemInt_Fast should prefer mapping over sequence protocol",
    "updated_at": "2017-08-08T10:03:10Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1807",
    "user": {
        "avatar_url": "https://avatars0.githubusercontent.com/u/3625785?v=4",
        "events_url": "https://api.github.com/users/jdemeyer/events{/privacy}",
        "followers_url": "https://api.github.com/users/jdemeyer/followers",
        "following_url": "https://api.github.com/users/jdemeyer/following{/other_user}",
        "gists_url": "https://api.github.com/users/jdemeyer/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jdemeyer",
        "id": 3625785,
        "login": "jdemeyer",
        "organizations_url": "https://api.github.com/users/jdemeyer/orgs",
        "received_events_url": "https://api.github.com/users/jdemeyer/received_events",
        "repos_url": "https://api.github.com/users/jdemeyer/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jdemeyer/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jdemeyer/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jdemeyer"
    }
}