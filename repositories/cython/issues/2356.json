{
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "Cython modules tend to be big (see #2102) and certain parts are the same for all modules. Especially in large installations, it would reduce the overall binary size to extract the shareable parts into a dedicated shared library that all modules link against.\r\n\r\nRandom notes:\r\n- Some internal types are already shared across modules, but their code is still duplicated across all modules. The first imported Cython module (of a given Cython version) registers it globally for all others, which will then not use their own implementations.\r\n- Cython can already extract its helpers into dedicated header files to reduce the build overhead. A shared library could be based on that.\r\n- Much of the performance of Cython code comes from inlined (and compile time streamlined) functions. Extracting those into a shared library would probably slow things down visibly, but could be a tradeoff.\r\n- Using a shared library adds quite some complexity. The library could be used globally for a Python installation (in which case it's unclear how to find it and which one to use if there are multiple), or local to an installed package. The latter is probably simpler but still requires some coordination on user side. A global library could come in as a separate package dependency that the Cython project could provide, but would introduce an exact version dependency based on the Cython version that a package was built with.\r\n- It is not entirely clear how to deal with the runtime linking here. A real shared library would have to be loaded together with the Cython module, i.e. there would have to be a way for the shared library loader to find it. It might be easier (and more portable) to use a Python extension module and explicitly import the code from there via capsules, in the same way that Cython currently imports its shared types from the first imported module.\r\n- Such a shared library would have to be complete in order to be usable by all Cython generated modules. It would thus be larger than what most single Cython modules (and even some small sets of Cython modules) actually need.\r\n- The potential gain is unclear. For large installations, there is certainly a gain even if only the shared types are extracted from each of the modules. However, large installations are rare. If a shared library is created on a per-package basis, there will still be a lot of duplication in a given Python installation.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thanks for writing this up @scoder. This is a very useful discussion to have.\r\n\r\nIt sounds like the first two points (internal types and helpers) are a good starting point for this shared library. Inlined functions would probably not be good in a shared library. That said, these should be profiled (if they haven't been already) to make sure inlining happens and is of significant value.\r\n\r\nAs to shared library management (points 4 and 5), the typical way, which I'm sure you know, to deal with this is use a SONAME. However the challenge becomes how do we install this. One option is we actually release a shared library with each Cython version to PyPI and anywhere else that include the SONAME in the package name (e.g. `libcython-0.28`). This makes it possible to install multiple versions and to ensure that code loads a compatible version. Similar strategies already occur in other package managers, which could easily adopt this. Managing this on PyPI may be a bit of a challenge without some improvements.\r\n\r\nIt's hard to reason about things like size without a simple prototype to inform one's intuition. Could you please suggest a few functions that might be reasonable for this sort of thing and/or where to look for them?",
            "created_at": "2018-06-19T23:29:03Z",
            "html_url": "https://github.com/cython/cython/issues/2356#issuecomment-398577128",
            "id": 398577128,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2356",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5ODU3NzEyOA==",
            "updated_at": "2018-06-19T23:29:03Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/398577128",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/3019665?v=4",
                "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
                "followers_url": "https://api.github.com/users/jakirkham/followers",
                "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
                "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jakirkham",
                "id": 3019665,
                "login": "jakirkham",
                "node_id": "MDQ6VXNlcjMwMTk2NjU=",
                "organizations_url": "https://api.github.com/users/jakirkham/orgs",
                "received_events_url": "https://api.github.com/users/jakirkham/received_events",
                "repos_url": "https://api.github.com/users/jakirkham/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jakirkham"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Much of the utility code in\nhttps://github.com/cython/cython/tree/master/Cython/Utility would be ripe\ncandidates for this sort of thing.\n\nRestricting the scope to a single (monolithically compiled) package would\nbe simpler, and I'd guess the most benefit would be for those packages that\nhave many, many cython modules in them anyways. (There's also been a\nrelated desire to compile multiple modules together in a single shared\nobject library; I wonder if we did this if there are tools for\ndeduplicating .so files that have multiple copies of the same exact\nfunction statically linked in... If there is such a tool I wonder if it\ncould give a ballpark estimate for what potential savings there might be\nfor a given collection of .so files.)\n\nWe could also ship a cython_runtime package, with wheels, on PyPi and allow\nany projects to link against that (either via the C library linking level,\nor, simpler, via the same methods we use for cimport).\n\nOn Tue, Jun 19, 2018 at 4:29 PM, jakirkham <notifications@github.com> wrote:\n\n> Thanks for writing this up @scoder <https://github.com/scoder>. This is a\n> very useful discussion to have.\n>\n> It sounds like the first two points (internal types and helpers) are a\n> good starting point for this shared library. Inlined functions would\n> probably not be good in a shared library. That said, these should be\n> profiled (if they haven't been already) to make sure inlining happens and\n> is of significant value.\n>\n> As to shared library management (points 4 and 5), the typical way, which\n> I'm sure you know, to deal with this is use a SONAME. However the challenge\n> becomes how do we install this. One option is we actually release a shared\n> library with each Cython version to PyPI and anywhere else that include the\n> SONAME in the package name (e.g. libcython-0.28). This makes it possible\n> to install multiple versions and to ensure that code loads a compatible\n> version. Similar strategies already occur in other package managers, which\n> could easily adopt this. Managing this on PyPI may be a bit of a challenge\n> without some improvements.\n>\n> It's hard to reason about things like size without a simple prototype to\n> inform one's intuition. Could you please suggest a few functions that might\n> be reasonable for this sort of thing and/or where to look for them?\n>\n> â€”\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/cython/cython/issues/2356#issuecomment-398577128>, or mute\n> the thread\n> <https://github.com/notifications/unsubscribe-auth/AAdqgSNwW4xKZFPA_QXhLpeDUcyQjGxMks5t-YlCgaJpZM4UqFUV>\n> .\n>\n",
            "created_at": "2018-06-20T00:47:26Z",
            "html_url": "https://github.com/cython/cython/issues/2356#issuecomment-398589160",
            "id": 398589160,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2356",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5ODU4OTE2MA==",
            "updated_at": "2018-06-20T00:47:26Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/398589160",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/486017?v=4",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "node_id": "MDQ6VXNlcjQ4NjAxNw==",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2356/comments",
    "created_at": "2018-06-15T20:05:19Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-06-15T20:06:07Z",
            "event": "labeled",
            "id": 1684177964,
            "label": {
                "color": "b60205",
                "name": "unclear"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE2ODQxNzc5NjQ=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1684177964"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-06-15T20:06:07Z",
            "event": "labeled",
            "id": 1684177969,
            "label": {
                "color": "444444",
                "name": "enhancement"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE2ODQxNzc5Njk=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1684177969"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-06-19T23:29:03Z",
            "event": "mentioned",
            "id": 1689906725,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MTY4OTkwNjcyNQ==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1689906725"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-06-19T23:29:03Z",
            "event": "subscribed",
            "id": 1689906726,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDE2ODk5MDY3MjY=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1689906726"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-06-20T00:47:26Z",
            "event": "mentioned",
            "id": 1689987934,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MTY4OTk4NzkzNA==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1689987934"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-06-20T00:47:26Z",
            "event": "subscribed",
            "id": 1689987935,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDE2ODk5ODc5MzU=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1689987935"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2356/events",
    "html_url": "https://github.com/cython/cython/issues/2356",
    "id": 332898688,
    "labels": [
        {
            "color": "444444",
            "default": true,
            "id": 425556243,
            "name": "enhancement",
            "node_id": "MDU6TGFiZWw0MjU1NTYyNDM=",
            "url": "https://api.github.com/repos/cython/cython/labels/enhancement"
        },
        {
            "color": "b60205",
            "default": false,
            "id": 414807834,
            "name": "unclear",
            "node_id": "MDU6TGFiZWw0MTQ4MDc4MzQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/unclear"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2356/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzMzI4OTg2ODg=",
    "number": 2356,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Use a shared library for shared code",
    "updated_at": "2018-06-20T00:47:26Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2356",
    "user": {
        "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
        "events_url": "https://api.github.com/users/scoder/events{/privacy}",
        "followers_url": "https://api.github.com/users/scoder/followers",
        "following_url": "https://api.github.com/users/scoder/following{/other_user}",
        "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/scoder",
        "id": 491659,
        "login": "scoder",
        "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
        "organizations_url": "https://api.github.com/users/scoder/orgs",
        "received_events_url": "https://api.github.com/users/scoder/received_events",
        "repos_url": "https://api.github.com/users/scoder/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/scoder"
    }
}