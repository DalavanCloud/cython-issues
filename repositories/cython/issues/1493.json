{
    "assignee": null,
    "assignees": [],
    "body": "Specifically, see line [1]: somehow, under some conditions, programs using uvloop were segfaulting, because `self->gi_name` is set to `NULL` when coroutine is finalized (same issue with `__qualname__`).  I already raised this issue on cython mailing list, and was suggested to fix this myself. Unfortunately I don't have time atm, but this is something that has to be fixed in Cython 0.25.\r\n\r\nRight now I'm forced to patch generated C files with an ugly hack in uvloop Makefile: [2]\r\n\r\n[1] https://github.com/cython/cython/blob/master/Cython/Utility/Coroutine.c#L951\r\n[2] https://github.com/MagicStack/uvloop/blob/master/Makefile#L95",
    "closed_at": "2016-10-19T08:47:06Z",
    "comment_data": [
        {
            "body": "Yeah, I had the same problem but I had problems with the mailing list and I just forgot about it.\r\nHere is the mail:\r\n\r\n> Hello,\r\n\r\n> I've been playing with asyncio and cython and found that the attached\r\ncode segfaults.\r\n\r\n\r\n>I looked at the generated C code and it tries to do\r\nPy_INCREF(self->gi_qualname); when retrieving __qualname__\r\nbut self->gi_qualname is NULL here because __Pyx_Coroutine_clear has\r\nalready been called.\r\nIf I comment this line then it \"works\" and i just run into this bug:\r\n\r\n>\"[cython-users] cython coroutine object  does not have 'cr_code' and\r\n'cr_frame' attributes.\"\r\n\r\nAnd here is a simple example:\r\n\r\n```python\r\nimport asyncio\r\n\r\ndef func():\r\n    task = asyncio.Task(func2())\r\n    def bug(task):\r\n        print(task)\r\n\r\n    task.add_done_callback(bug)\r\n\r\n\r\nasync def func2():\r\n    await asyncio.sleep(1)\r\n\r\nloop = asyncio.get_event_loop()\r\nfunc()\r\nloop.run_forever()\r\n```",
            "created_at": "2016-10-18T18:36:22Z",
            "html_url": "https://github.com/cython/cython/issues/1493#issuecomment-254599082",
            "id": 254599082,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1493",
            "updated_at": "2016-10-18T18:36:22Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/254599082",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3650385?v=3",
                "events_url": "https://api.github.com/users/Eijebong/events{/privacy}",
                "followers_url": "https://api.github.com/users/Eijebong/followers",
                "following_url": "https://api.github.com/users/Eijebong/following{/other_user}",
                "gists_url": "https://api.github.com/users/Eijebong/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Eijebong",
                "id": 3650385,
                "login": "Eijebong",
                "organizations_url": "https://api.github.com/users/Eijebong/orgs",
                "received_events_url": "https://api.github.com/users/Eijebong/received_events",
                "repos_url": "https://api.github.com/users/Eijebong/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Eijebong/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Eijebong/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Eijebong"
            }
        },
        {
            "body": "Thanks a lot!",
            "created_at": "2016-10-19T15:55:41Z",
            "html_url": "https://github.com/cython/cython/issues/1493#issuecomment-254856844",
            "id": 254856844,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1493",
            "updated_at": "2016-10-19T15:55:41Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/254856844",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/239003?v=3",
                "events_url": "https://api.github.com/users/1st1/events{/privacy}",
                "followers_url": "https://api.github.com/users/1st1/followers",
                "following_url": "https://api.github.com/users/1st1/following{/other_user}",
                "gists_url": "https://api.github.com/users/1st1/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/1st1",
                "id": 239003,
                "login": "1st1",
                "organizations_url": "https://api.github.com/users/1st1/orgs",
                "received_events_url": "https://api.github.com/users/1st1/received_events",
                "repos_url": "https://api.github.com/users/1st1/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/1st1/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/1st1/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/1st1"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1493/comments",
    "created_at": "2016-10-18T18:16:12Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=3",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "176ed5e41e30520dbad4a5c3b9d4cc34cb84a359",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/176ed5e41e30520dbad4a5c3b9d4cc34cb84a359",
            "created_at": "2016-10-19T08:47:06Z",
            "event": "closed",
            "id": 828712999,
            "url": "https://api.github.com/repos/cython/cython/issues/events/828712999"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1493/events",
    "html_url": "https://github.com/cython/cython/issues/1493",
    "id": 183763410,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1493/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1493,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Coroutines can segfault on __name__ access",
    "updated_at": "2016-10-19T15:55:41Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1493",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/239003?v=3",
        "events_url": "https://api.github.com/users/1st1/events{/privacy}",
        "followers_url": "https://api.github.com/users/1st1/followers",
        "following_url": "https://api.github.com/users/1st1/following{/other_user}",
        "gists_url": "https://api.github.com/users/1st1/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/1st1",
        "id": 239003,
        "login": "1st1",
        "organizations_url": "https://api.github.com/users/1st1/orgs",
        "received_events_url": "https://api.github.com/users/1st1/received_events",
        "repos_url": "https://api.github.com/users/1st1/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/1st1/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/1st1/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/1st1"
    }
}