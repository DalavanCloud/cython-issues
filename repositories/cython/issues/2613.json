{
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "In some cases, Cython produces invalid C code:\r\n\r\n```\r\n$ cat mylib.pyx \r\ncdef object py_retval\r\n\r\nasync def test():\r\n    global py_retval\r\n    py_retval = {'foo': 42}\r\n\r\n$ cython --version\r\nCython version 0.28.5\r\n\r\n$ cython -3 -Wextra --force -3 --directive embedsignature=True mylib.pyx --fast-fail\r\n\r\n$ python3 ./setup.py build_ext --inplace\r\nrunning build_ext\r\nbuilding 'mylib' extension\r\nx86_64-linux-gnu-gcc -pthread -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -g -fdebug-prefix-map=/build/python3.5-MLq5fN/python3.5-3.5.3=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -I/usr/include/python3.5m -c mylib.c -o build/temp.linux-x86_64-3.5/mylib.o -Wall -Wextra\r\nmylib.c: In function ‘__Pyx_modinit_global_init_code’:\r\nmylib.c:1422:3: error: ‘__pyx_cur_scope’ undeclared (first use in this function)\r\n   __pyx_cur_scope->__pyx_v_5mylib_py_retval = Py_None; Py_INCREF(Py_None);\r\n   ^~~~~~~~~~~~~~~\r\nmylib.c:1422:3: note: each undeclared identifier is reported only once for each function it appears in\r\nerror: command 'x86_64-linux-gnu-gcc' failed with exit status 1\r\n```\r\n\r\n[testcase.zip](https://github.com/cython/cython/files/2391748/testcase.zip)\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
    "closed_at": "2018-09-22T13:08:31Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Also reproduced with current git master (Cython version 0.29a0)",
            "created_at": "2018-09-18T08:17:48Z",
            "html_url": "https://github.com/cython/cython/issues/2613#issuecomment-422300160",
            "id": 422300160,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2613",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjMwMDE2MA==",
            "updated_at": "2018-09-18T08:17:48Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/422300160",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/701625?v=4",
                "events_url": "https://api.github.com/users/Nikratio/events{/privacy}",
                "followers_url": "https://api.github.com/users/Nikratio/followers",
                "following_url": "https://api.github.com/users/Nikratio/following{/other_user}",
                "gists_url": "https://api.github.com/users/Nikratio/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Nikratio",
                "id": 701625,
                "login": "Nikratio",
                "node_id": "MDQ6VXNlcjcwMTYyNQ==",
                "organizations_url": "https://api.github.com/users/Nikratio/orgs",
                "received_events_url": "https://api.github.com/users/Nikratio/received_events",
                "repos_url": "https://api.github.com/users/Nikratio/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Nikratio/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Nikratio/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Nikratio"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Looks like an analysis problem. The variable `py_type` is mostly just used as a global in plain cdef functions, but also in an async coroutine function in `fuse_api.pxi`. My guess is that this is the place where the type analysis erroneously decides that it is part of a closure, although it is clearly also declared as a global in that function.",
            "created_at": "2018-09-18T21:11:44Z",
            "html_url": "https://github.com/cython/cython/issues/2613#issuecomment-422556660",
            "id": 422556660,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2613",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjU1NjY2MA==",
            "updated_at": "2018-09-18T21:11:44Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/422556660",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Probably trivial to fix, once we find the place where that happens.",
            "created_at": "2018-09-18T21:13:00Z",
            "html_url": "https://github.com/cython/cython/issues/2613#issuecomment-422557140",
            "id": 422557140,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2613",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjU1NzE0MA==",
            "updated_at": "2018-09-18T21:13:00Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/422557140",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "`fuse_api.pxi`? That's weird, I replaced the original huge testcase with a tiny one just a few minutes after filing the issue. Could you try to refresh? This should show you something much more tractable :-).",
            "created_at": "2018-09-19T08:12:35Z",
            "html_url": "https://github.com/cython/cython/issues/2613#issuecomment-422702645",
            "id": 422702645,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2613",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjcwMjY0NQ==",
            "updated_at": "2018-09-19T08:12:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/422702645",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/701625?v=4",
                "events_url": "https://api.github.com/users/Nikratio/events{/privacy}",
                "followers_url": "https://api.github.com/users/Nikratio/followers",
                "following_url": "https://api.github.com/users/Nikratio/following{/other_user}",
                "gists_url": "https://api.github.com/users/Nikratio/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Nikratio",
                "id": 701625,
                "login": "Nikratio",
                "node_id": "MDQ6VXNlcjcwMTYyNQ==",
                "organizations_url": "https://api.github.com/users/Nikratio/orgs",
                "received_events_url": "https://api.github.com/users/Nikratio/received_events",
                "repos_url": "https://api.github.com/users/Nikratio/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Nikratio/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Nikratio/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Nikratio"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The test case is pretty much what I expected, thanks for simplifying it.",
            "created_at": "2018-09-19T08:25:48Z",
            "html_url": "https://github.com/cython/cython/issues/2613#issuecomment-422706804",
            "id": 422706804,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2613",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMjcwNjgwNA==",
            "updated_at": "2018-09-19T08:25:48Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/422706804",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2613/comments",
    "created_at": "2018-09-18T08:04:31Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-09-18T21:12:05Z",
            "event": "labeled",
            "id": 1853511412,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE4NTM1MTE0MTI=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1853511412"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-09-18T21:12:05Z",
            "event": "labeled",
            "id": 1853511416,
            "label": {
                "color": "444444",
                "name": "Type Analysis"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE4NTM1MTE0MTY=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1853511416"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-09-18T21:12:20Z",
            "event": "milestoned",
            "id": 1853512106,
            "milestone": {
                "title": "0.29"
            },
            "node_id": "MDE1Ok1pbGVzdG9uZWRFdmVudDE4NTM1MTIxMDY=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1853512106"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-09-18T21:13:11Z",
            "event": "labeled",
            "id": 1853513955,
            "label": {
                "color": "0e8a16",
                "name": "help wanted"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE4NTM1MTM5NTU=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1853513955"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-09-18T21:13:11Z",
            "event": "labeled",
            "id": 1853513963,
            "label": {
                "color": "1d76db",
                "name": "good first issue"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE4NTM1MTM5NjM=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1853513963"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "1644e44c921123d712d49cfceba9e360acd6bb64",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/1644e44c921123d712d49cfceba9e360acd6bb64",
            "created_at": "2018-09-22T13:08:31Z",
            "event": "closed",
            "id": 1861593194,
            "node_id": "MDExOkNsb3NlZEV2ZW50MTg2MTU5MzE5NA==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1861593194"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2613/events",
    "html_url": "https://github.com/cython/cython/issues/2613",
    "id": 361182460,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "id": 425558824,
            "name": "Type Analysis",
            "node_id": "MDU6TGFiZWw0MjU1NTg4MjQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/Type%20Analysis"
        },
        {
            "color": "444444",
            "default": false,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        },
        {
            "color": "1d76db",
            "default": true,
            "id": 414805682,
            "name": "good first issue",
            "node_id": "MDU6TGFiZWw0MTQ4MDU2ODI=",
            "url": "https://api.github.com/repos/cython/cython/labels/good%20first%20issue"
        },
        {
            "color": "0e8a16",
            "default": true,
            "id": 414800879,
            "name": "help wanted",
            "node_id": "MDU6TGFiZWw0MTQ4MDA4Nzk=",
            "url": "https://api.github.com/repos/cython/cython/labels/help%20wanted"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2613/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 42,
        "created_at": "2018-03-06T19:20:48Z",
        "creator": {
            "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
            "events_url": "https://api.github.com/users/scoder/events{/privacy}",
            "followers_url": "https://api.github.com/users/scoder/followers",
            "following_url": "https://api.github.com/users/scoder/following{/other_user}",
            "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/scoder",
            "id": 491659,
            "login": "scoder",
            "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
            "organizations_url": "https://api.github.com/users/scoder/orgs",
            "received_events_url": "https://api.github.com/users/scoder/received_events",
            "repos_url": "https://api.github.com/users/scoder/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/scoder"
        },
        "description": null,
        "due_on": null,
        "html_url": "https://github.com/cython/cython/milestone/51",
        "id": 3166944,
        "labels_url": "https://api.github.com/repos/cython/cython/milestones/51/labels",
        "node_id": "MDk6TWlsZXN0b25lMzE2Njk0NA==",
        "number": 51,
        "open_issues": 0,
        "state": "open",
        "title": "0.29",
        "updated_at": "2018-09-22T13:44:32Z",
        "url": "https://api.github.com/repos/cython/cython/milestones/51"
    },
    "node_id": "MDU6SXNzdWUzNjExODI0NjA=",
    "number": 2613,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Cython produces invalid C in some cases",
    "updated_at": "2018-09-22T13:08:31Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2613",
    "user": {
        "avatar_url": "https://avatars1.githubusercontent.com/u/701625?v=4",
        "events_url": "https://api.github.com/users/Nikratio/events{/privacy}",
        "followers_url": "https://api.github.com/users/Nikratio/followers",
        "following_url": "https://api.github.com/users/Nikratio/following{/other_user}",
        "gists_url": "https://api.github.com/users/Nikratio/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Nikratio",
        "id": 701625,
        "login": "Nikratio",
        "node_id": "MDQ6VXNlcjcwMTYyNQ==",
        "organizations_url": "https://api.github.com/users/Nikratio/orgs",
        "received_events_url": "https://api.github.com/users/Nikratio/received_events",
        "repos_url": "https://api.github.com/users/Nikratio/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Nikratio/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Nikratio/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Nikratio"
    }
}