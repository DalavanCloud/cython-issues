{
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "If I cythonize the following code:\r\n```\r\n# cython: language_level=3\r\n\r\ncpdef use_dict(dict d, u, v, w):\r\n    if u in d:\r\n        del d[u]\r\n    d.pop(v, None)\r\n    d[w] = 1\r\n    return [x for x in d if x]\r\n\r\ncpdef use_set(set s, u, v, w):\r\n    if u in s:\r\n        s.remove(u)\r\n    s.discard(v)\r\n    s.add(w)\r\n    return [x for x in s if x]\r\n```\r\n\r\nThen most of `use_dict` exploits the `PyDict`concrete APIs (except for the `.pop` call which goes through a Python method call), but `use_set` exploits none of the `PySet` concrete API except for `PySet_Add`.",
    "closed_at": "2017-12-18T22:56:45Z",
    "comment_data": [
        {
            "author_association": "OWNER",
            "body": "The C-API functions are actually not equivalent to the Python methods. Using them would require some additional special handling in dedicated utility code functions for a set of sets. See the comments here:\r\nhttps://github.com/cython/cython/blob/a8a2ddff5b712badec75392932b00b2b8ba4cd4e/Cython/Compiler/Builtin.py#L328-L336\r\n\r\nAnd the implementation in CPython here:\r\nhttps://github.com/python/cpython/blob/13ad3b7a82bf56d803fbe48ee5df6c4b08986c78/Objects/setobject.c#L1950-L1970\r\n\r\nBut I agree that the normal fast-path (key is hashable) is worth handling in C rather than Python method calls, so we should copy over the code from CPython and adapt it appropriately.",
            "created_at": "2017-12-15T09:01:34Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-351951055",
            "id": 351951055,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-15T09:43:59Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/351951055",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I could perhaps give it a try, but you'd have to tell me where to add the relevant tests and how to run the test suite to avoid having it take an overly long time :-)",
            "created_at": "2017-12-15T16:31:22Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-352049912",
            "id": 352049912,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-15T16:31:22Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/352049912",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        },
        {
            "author_association": "OWNER",
            "body": "Sure. The helper functions should go into `Cython/Utility/Builtins.c`. There are already a couple of set related functions at the end. The file is split into named sections, the \".proto\" section is written early into the .c file, the unsuffixed section is the main implementation and goes in late.\r\n\r\n`Cython/Compiler/Builtin.py` provides the mapping from builtins and their methods to C names/functions. It has various examples that load utility functions In the signature string, just take a look at the `set.update()` comment I mentioned. In the signature string, `T` refers to the self type, `O` is an arbitrary object.\r\n\r\nYou can add the tests to `tests/run/set.pyx`. The doctests are executed in Python, the rest of the file is compiled. To run the tests: `python runtests.py --debug -vv run.set`.",
            "created_at": "2017-12-15T19:56:29Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-352097396",
            "id": 352097396,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-15T20:06:38Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/352097396",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Ok, one oddity: `Cython/Compiler/Builtin.py` says `set.__contains__` should generate a call to `PySequence_Contains`, but actually a call to `__Pyx_PySequence_ContainsTF` is generated. Is the `set.__contains__` specification simply ignored?",
            "created_at": "2017-12-16T17:57:55Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-352199586",
            "id": 352199586,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-16T17:57:55Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/352199586",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "(I opened a PR at https://github.com/cython/cython/pull/2044; it tackles the `remove` and `discard` methods, but not `__contains__` for the reason stated above)",
            "created_at": "2017-12-16T18:54:03Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-352203365",
            "id": 352203365,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-16T18:54:03Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/352203365",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        },
        {
            "author_association": "OWNER",
            "body": "> `__Pyx_PySequence_ContainsTF`\r\n\r\nYes, `Builtin.py` only applies basic adaptations. Some further optimisations are done programmatically later on, often depending on input *and* output types, for example.",
            "created_at": "2017-12-17T11:07:35Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-352247882",
            "id": 352247882,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-17T11:07:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/352247882",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Is calling `__Pyx_PySequence_ContainsTF` instead of `PySequence_Contains` actually an optimization?\r\n\r\nIf I replace the `__contains__` slot for sets with `PySet_Contains`, it's still `__Pyx_PySequence_ContainsTF` that is called...",
            "created_at": "2017-12-17T11:14:19Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-352248228",
            "id": 352248228,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-17T11:14:19Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/352248228",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        },
        {
            "author_association": "OWNER",
            "body": "I had to look that up myself, it's actually different again. It's a helper function that is used to implement both `in` and `not in` in one function, based on an additional argument. The tricky bit is that it needs to pass the exception return value through, which is why it's not just a simple macro. Performance-wise, it most likely makes zero difference.\r\n\r\nAlso note that the `__contains__` method in `Bultin.py` really only handles cases where `x.__contains__` is used explicitly. I added that years ago mostly to allow undoing the assignment of unbound methods that some people do in Python code to avoid a method lookup in loops. If Cython can see the underlying method call and understand that it can replace it with a C function call, that's obviously much faster than any unbound Python method call.",
            "created_at": "2017-12-17T11:24:32Z",
            "html_url": "https://github.com/cython/cython/issues/2042#issuecomment-352248798",
            "id": 352248798,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2042",
            "updated_at": "2017-12-17T11:24:32Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/352248798",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 8,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2042/comments",
    "created_at": "2017-12-12T16:38:08Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/486017?v=4",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2017-12-12T19:17:42Z",
            "event": "labeled",
            "id": 1384239026,
            "label": {
                "color": "1d76db",
                "name": "good first issue"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/1384239026"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2017-12-15T19:21:12Z",
            "event": "labeled",
            "id": 1390180831,
            "label": {
                "color": "0e8a16",
                "name": "help wanted"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/1390180831"
        },
        {
            "actor": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            },
            "commit_id": "757c030e15f8ed317b90271f184d13ef5651aebb",
            "commit_url": "https://api.github.com/repos/pitrou/cython/commits/757c030e15f8ed317b90271f184d13ef5651aebb",
            "created_at": "2017-12-16T17:58:53Z",
            "event": "referenced",
            "id": 1390827698,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1390827698"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "822ac41460ca19b21ad529d099fb843dfe191200",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/822ac41460ca19b21ad529d099fb843dfe191200",
            "created_at": "2017-12-18T22:11:25Z",
            "event": "referenced",
            "id": 1393049718,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1393049718"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "e801d21add49f8f841b76c1420b448334dd80e04",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/e801d21add49f8f841b76c1420b448334dd80e04",
            "created_at": "2017-12-18T22:56:45Z",
            "event": "closed",
            "id": 1393113845,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1393113845"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2042/events",
    "html_url": "https://github.com/cython/cython/issues/2042",
    "id": 281452287,
    "labels": [
        {
            "color": "1d76db",
            "default": true,
            "id": 414805682,
            "name": "good first issue",
            "url": "https://api.github.com/repos/cython/cython/labels/good%20first%20issue"
        },
        {
            "color": "0e8a16",
            "default": true,
            "id": 414800879,
            "name": "help wanted",
            "url": "https://api.github.com/repos/cython/cython/labels/help%20wanted"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2042/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 2042,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Cython makes little use of PySet APIs",
    "updated_at": "2017-12-18T22:56:45Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2042",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/1721820?v=4",
        "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
        "followers_url": "https://api.github.com/users/pitrou/followers",
        "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
        "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/pitrou",
        "id": 1721820,
        "login": "pitrou",
        "organizations_url": "https://api.github.com/users/pitrou/orgs",
        "received_events_url": "https://api.github.com/users/pitrou/received_events",
        "repos_url": "https://api.github.com/users/pitrou/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/pitrou"
    }
}