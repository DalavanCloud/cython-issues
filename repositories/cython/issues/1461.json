{
    "assignee": null,
    "assignees": [],
    "body": "I'm trying to enable a coverage for cython modules for [multidict](https://github.com/aio-libs/multidict) library. `Cython.Coverage` plugin works but the [coverage output](https://codecov.io/gh/aio-libs/multidict/src/cf1458ba151cffd74972cf00471ed09b9d6ee0dc/multidict/_multidict.pyx) looks incorrect.\n\nThe tool blames that method definitions are not executed lines but it's definitely wrong because method bodies are executed and test covered.\n\nWhat I do wrong?\n",
    "closed_at": null,
    "comment_data": [
        {
            "body": "Did you try latest master?",
            "created_at": "2016-09-16T11:37:11Z",
            "html_url": "https://github.com/cython/cython/issues/1461#issuecomment-247579578",
            "id": 247579578,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1461",
            "updated_at": "2016-09-16T11:37:11Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/247579578",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=3",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "I've tried cython 0.24.1\r\nOn master I have another error:\r\n```\r\nINTERNALERROR>     wrap_controller.send(call_outcome)\r\nINTERNALERROR>   File \"/home/andrew/.virtualenvs/multidict/lib/python3.5/site-packages/pytest_cov/plugin.py\", line 212, in pytest_runtestloop\r\nINTERNALERROR>     self.cov_controller.finish()\r\nINTERNALERROR>   File \"/home/andrew/.virtualenvs/multidict/lib/python3.5/site-packages/pytest_cov/engine.py\", line 150, in finish\r\nINTERNALERROR>     self.cov.combine()\r\nINTERNALERROR>   File \"/home/andrew/.virtualenvs/multidict/lib/python3.5/site-packages/coverage/control.py\", line 784, in combine\r\nINTERNALERROR>     self.get_data()\r\nINTERNALERROR>   File \"/home/andrew/.virtualenvs/multidict/lib/python3.5/site-packages/coverage/control.py\", line 810, in get_data\r\nINTERNALERROR>     self.collector.save_data(self.data)\r\nINTERNALERROR>   File \"/home/andrew/.virtualenvs/multidict/lib/python3.5/site-packages/coverage/collector.py\", line 349, in save_data\r\nINTERNALERROR>     covdata.add_arcs(abs_file_dict(self.data))\r\nINTERNALERROR>   File \"/home/andrew/.virtualenvs/multidict/lib/python3.5/site-packages/coverage/data.py\", line 365, in add_arcs\r\nINTERNALERROR>     raise CoverageException(\"Can't add arcs to existing line data\")\r\nINTERNALERROR> coverage.misc.CoverageException: Can't add arcs to existing line data\r\n```",
            "created_at": "2016-09-16T11:54:29Z",
            "html_url": "https://github.com/cython/cython/issues/1461#issuecomment-247582341",
            "id": 247582341,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1461",
            "updated_at": "2016-09-16T11:54:29Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/247582341",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/356399?v=3",
                "events_url": "https://api.github.com/users/asvetlov/events{/privacy}",
                "followers_url": "https://api.github.com/users/asvetlov/followers",
                "following_url": "https://api.github.com/users/asvetlov/following{/other_user}",
                "gists_url": "https://api.github.com/users/asvetlov/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/asvetlov",
                "id": 356399,
                "login": "asvetlov",
                "organizations_url": "https://api.github.com/users/asvetlov/orgs",
                "received_events_url": "https://api.github.com/users/asvetlov/received_events",
                "repos_url": "https://api.github.com/users/asvetlov/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/asvetlov/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/asvetlov/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/asvetlov"
            }
        },
        {
            "body": "Aha, `coverage combine` doesn't work somehow.\r\nAnyway, even without combining I have the same behavior (method definitions are not covered) on cython master too.",
            "created_at": "2016-09-16T11:56:56Z",
            "html_url": "https://github.com/cython/cython/issues/1461#issuecomment-247582761",
            "id": 247582761,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1461",
            "updated_at": "2016-09-16T11:56:56Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/247582761",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/356399?v=3",
                "events_url": "https://api.github.com/users/asvetlov/events{/privacy}",
                "followers_url": "https://api.github.com/users/asvetlov/followers",
                "following_url": "https://api.github.com/users/asvetlov/following{/other_user}",
                "gists_url": "https://api.github.com/users/asvetlov/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/asvetlov",
                "id": 356399,
                "login": "asvetlov",
                "organizations_url": "https://api.github.com/users/asvetlov/orgs",
                "received_events_url": "https://api.github.com/users/asvetlov/received_events",
                "repos_url": "https://api.github.com/users/asvetlov/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/asvetlov/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/asvetlov/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/asvetlov"
            }
        },
        {
            "body": "Steps to reproduce:\r\n1. Clone https://github.com/aio-libs/multidict\r\n2. Switch to `cython_coverage` branch\r\n3. Run `pip install -r requirements-ci.txt`\r\n4. Run `make cov-dev`, open prompted  html file.\r\nMethod definition lines from `multidict/_multidict.pyx` are not covered. \r\n5. For demonstrating issue with coverage files combining run `make cov-dev-full`.",
            "created_at": "2016-09-16T16:04:09Z",
            "html_url": "https://github.com/cython/cython/issues/1461#issuecomment-247639851",
            "id": 247639851,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1461",
            "updated_at": "2016-09-16T16:04:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/247639851",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/356399?v=3",
                "events_url": "https://api.github.com/users/asvetlov/events{/privacy}",
                "followers_url": "https://api.github.com/users/asvetlov/followers",
                "following_url": "https://api.github.com/users/asvetlov/following{/other_user}",
                "gists_url": "https://api.github.com/users/asvetlov/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/asvetlov",
                "id": 356399,
                "login": "asvetlov",
                "organizations_url": "https://api.github.com/users/asvetlov/orgs",
                "received_events_url": "https://api.github.com/users/asvetlov/received_events",
                "repos_url": "https://api.github.com/users/asvetlov/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/asvetlov/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/asvetlov/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/asvetlov"
            }
        },
        {
            "body": "Without having looked at the code, my guess is that we simply don't generate trace calls for function/method/class declarations. The whole tracing support works by explicitly calling the tracer before the C code that is generated for each line of user code that gets executed, and declarations aren't really considered user code. The trace call would need to get added to the instantiation of class objects and functions. AFAIR, we already trace the user code in the module init function, so this should generally be possible, although some C things might happen in an unexpected order in Cython.",
            "created_at": "2016-10-15T12:01:44Z",
            "html_url": "https://github.com/cython/cython/issues/1461#issuecomment-253980227",
            "id": 253980227,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1461",
            "updated_at": "2016-10-15T12:01:44Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/253980227",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=3",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "Facing the same issue... Method definitions (def/cpdef/cdef) in cdef classes are not covered, when they should be.\r\n\r\nAlso found person facing the same issue on SO - http://stackoverflow.com/questions/34935796/how-to-use-coverage-analysis-with-cython",
            "created_at": "2016-11-02T09:19:56Z",
            "html_url": "https://github.com/cython/cython/issues/1461#issuecomment-257811700",
            "id": 257811700,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1461",
            "updated_at": "2016-11-02T09:19:56Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/257811700",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1742049?v=3",
                "events_url": "https://api.github.com/users/rmk135/events{/privacy}",
                "followers_url": "https://api.github.com/users/rmk135/followers",
                "following_url": "https://api.github.com/users/rmk135/following{/other_user}",
                "gists_url": "https://api.github.com/users/rmk135/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/rmk135",
                "id": 1742049,
                "login": "rmk135",
                "organizations_url": "https://api.github.com/users/rmk135/orgs",
                "received_events_url": "https://api.github.com/users/rmk135/received_events",
                "repos_url": "https://api.github.com/users/rmk135/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/rmk135/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/rmk135/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/rmk135"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1461/comments",
    "created_at": "2016-09-16T11:27:16Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1461/events",
    "html_url": "https://github.com/cython/cython/issues/1461",
    "id": 177403362,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1461/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1461,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Cython coverage tool blames that function definition lines are not covered",
    "updated_at": "2016-11-02T09:19:56Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1461",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/356399?v=3",
        "events_url": "https://api.github.com/users/asvetlov/events{/privacy}",
        "followers_url": "https://api.github.com/users/asvetlov/followers",
        "following_url": "https://api.github.com/users/asvetlov/following{/other_user}",
        "gists_url": "https://api.github.com/users/asvetlov/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/asvetlov",
        "id": 356399,
        "login": "asvetlov",
        "organizations_url": "https://api.github.com/users/asvetlov/orgs",
        "received_events_url": "https://api.github.com/users/asvetlov/received_events",
        "repos_url": "https://api.github.com/users/asvetlov/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/asvetlov/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/asvetlov/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/asvetlov"
    }
}