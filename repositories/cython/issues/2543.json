{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "I managed to get inspect working, mostly, with cython files using `binding=True`. However, now I ran into another issue where `co_filename` is set to the relative path of the pyx file at the time of the compile. This means that as soon as you you change directory, we cannot find the source file using `co_filename` as it doesn't map to the right path.\r\n\r\nLooking at the generated c file, the problem is with the filename passed to `__Pyx_PyCode_New`. The value seems to be generated here: https://github.com/cython/cython/blob/master/Cython/Compiler/ExprNodes.py#L9396. By changing `file_path = StringEncoding.bytes_literal(func.pos[0].get_filenametable_entry().encode('utf8'), 'utf8')` to `file_path = StringEncoding.bytes_literal(os.path.abspath(func.pos[0].get_filenametable_entry()).encode('utf8'), 'utf8')`, the abs path was saved in the generated c file. Although I'm not sure this is the correct fix, or whether there are other implications to saving the full path.\r\n\r\nMy `kv_cython_test.pyx` file contains\r\n```py\r\n#cython: binding=True\r\n\r\nfrom kivy.uix.widget import Widget\r\nfrom kivy.lang.compiler import KV, KVCtx\r\n\r\nclass MyWidget(Widget):\r\n\r\n    def apply_kv(self):\r\n        with KVCtx():\r\n            self.x @= self.y\r\n```\r\n\r\nand is right next to the setup.py file that contains \r\n```py\r\nfrom distutils.core import setup\r\nfrom Cython.Build import cythonize\r\nfrom os.path import join, dirname, abspath\r\n\r\nsetup(\r\n    ext_modules=cythonize(abspath(join(dirname(__file__), \"kv_cython_test.pyx\")))\r\n)\r\n```",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "The only way to determine the path of the current module at module init time is [PEP 489](https://www.python.org/dev/peps/pep-0489/), and that cannot generally be implemented for an arbitrary extension module.\r\n\r\nUsing the build time path in the compiled module is not a good idea, as the module will be installed in an arbitrary place, most likely not the place where it was built.",
            "created_at": "2018-08-10T07:36:36Z",
            "html_url": "https://github.com/cython/cython/issues/2543#issuecomment-412001888",
            "id": 412001888,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2543",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjAwMTg4OA==",
            "updated_at": "2018-08-10T07:36:36Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/412001888",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "For my use case, I'm making the assumption that the pyx file is not moved, even if the pyd file is compiled to some random location, because the usage would happen within the same setup that compiled the files. \r\n\r\nOtherwise, inspect would definitely not work, because there may not even be a pyx file around anymore if we lift that assumption. It would be the same as if the py file is moved, and the pyc file is loaded instead. Inspect should fail then for normal .py files because it wouldn't be able to locate the original file.\r\n\r\nSo this would be used in the equivalent setup where both the original .py and .pyc file are still around, so we should ideally also be able to make it work with cython when the original .pyx is still around at its original location.\r\n\r\nI suppose I could say that my tool must be used from the same path where the files were compiled - that will be my current workaround, but it would be nice if that restriction wasn't there when the original .pyx is still around.",
            "created_at": "2018-08-10T08:22:42Z",
            "html_url": "https://github.com/cython/cython/issues/2543#issuecomment-412012813",
            "id": 412012813,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2543",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjAxMjgxMw==",
            "updated_at": "2018-08-10T08:22:42Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/412012813",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1644286?v=4",
                "events_url": "https://api.github.com/users/matham/events{/privacy}",
                "followers_url": "https://api.github.com/users/matham/followers",
                "following_url": "https://api.github.com/users/matham/following{/other_user}",
                "gists_url": "https://api.github.com/users/matham/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matham",
                "id": 1644286,
                "login": "matham",
                "node_id": "MDQ6VXNlcjE2NDQyODY=",
                "organizations_url": "https://api.github.com/users/matham/orgs",
                "received_events_url": "https://api.github.com/users/matham/received_events",
                "repos_url": "https://api.github.com/users/matham/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matham/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matham/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matham"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The normal approach would be to install the Cython source files together with the binaries so that they can be looked up for tracebacks etc., just like Python finds the .py sources if they are around. Used to work in Py2.x, no longer works in Py3 due to https://bugs.python.org/issue32797 .",
            "created_at": "2018-08-10T09:02:20Z",
            "html_url": "https://github.com/cython/cython/issues/2543#issuecomment-412023214",
            "id": 412023214,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2543",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjAyMzIxNA==",
            "updated_at": "2018-08-10T09:02:20Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/412023214",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "Hmm, ok. That makes sense. Should I close this then?",
            "created_at": "2018-08-10T15:45:39Z",
            "html_url": "https://github.com/cython/cython/issues/2543#issuecomment-412123537",
            "id": 412123537,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2543",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjEyMzUzNw==",
            "updated_at": "2018-08-10T15:45:39Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/412123537",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1644286?v=4",
                "events_url": "https://api.github.com/users/matham/events{/privacy}",
                "followers_url": "https://api.github.com/users/matham/followers",
                "following_url": "https://api.github.com/users/matham/following{/other_user}",
                "gists_url": "https://api.github.com/users/matham/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matham",
                "id": 1644286,
                "login": "matham",
                "node_id": "MDQ6VXNlcjE2NDQyODY=",
                "organizations_url": "https://api.github.com/users/matham/orgs",
                "received_events_url": "https://api.github.com/users/matham/received_events",
                "repos_url": "https://api.github.com/users/matham/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matham/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matham/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matham"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Enough of PEP-489 is implemented now to make this work.",
            "created_at": "2018-12-11T19:36:06Z",
            "html_url": "https://github.com/cython/cython/issues/2543#issuecomment-446333001",
            "id": 446333001,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2543",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ0NjMzMzAwMQ==",
            "updated_at": "2018-12-11T19:36:06Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/446333001",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2543/comments",
    "created_at": "2018-08-10T07:31:34Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-12-11T19:36:24Z",
            "event": "labeled",
            "id": 2019671237,
            "label": {
                "color": "0e8a16",
                "name": "help wanted"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIwMTk2NzEyMzc=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2019671237"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-12-11T19:36:24Z",
            "event": "labeled",
            "id": 2019671246,
            "label": {
                "color": "444444",
                "name": "Python Semantics"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIwMTk2NzEyNDY=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2019671246"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2543/events",
    "html_url": "https://github.com/cython/cython/issues/2543",
    "id": 349406256,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "id": 425556315,
            "name": "Python Semantics",
            "node_id": "MDU6TGFiZWw0MjU1NTYzMTU=",
            "url": "https://api.github.com/repos/cython/cython/labels/Python%20Semantics"
        },
        {
            "color": "0e8a16",
            "default": true,
            "id": 414800879,
            "name": "help wanted",
            "node_id": "MDU6TGFiZWw0MTQ4MDA4Nzk=",
            "url": "https://api.github.com/repos/cython/cython/labels/help%20wanted"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2543/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzNDk0MDYyNTY=",
    "number": 2543,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "co_filename is relative rather than absolute",
    "updated_at": "2018-12-11T19:36:24Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2543",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/1644286?v=4",
        "events_url": "https://api.github.com/users/matham/events{/privacy}",
        "followers_url": "https://api.github.com/users/matham/followers",
        "following_url": "https://api.github.com/users/matham/following{/other_user}",
        "gists_url": "https://api.github.com/users/matham/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/matham",
        "id": 1644286,
        "login": "matham",
        "node_id": "MDQ6VXNlcjE2NDQyODY=",
        "organizations_url": "https://api.github.com/users/matham/orgs",
        "received_events_url": "https://api.github.com/users/matham/received_events",
        "repos_url": "https://api.github.com/users/matham/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/matham/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/matham/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/matham"
    }
}