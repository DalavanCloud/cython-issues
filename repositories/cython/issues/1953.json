{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "https://github.com/cython/cython/issues/1894#issuecomment-339966952.\r\n\r\nI'm getting an `AttributeError` due to a missing `__reduce_cython__` attribute in an embedded environment when I build lxml with Cython 0.26 or 0.27. 0.25(.2) works fine. The issue seems to be triggered by reinitializing the environment but unfortunately I was not able to find a minimal sample that replicates it yet.\r\n\r\nI did a git-bisect and found https://github.com/cython/cython/commit/f8b3405e926d2ba9bc2ee24d79848235875ee12e to be the first broken commit.\r\n\r\nWill try to find a simple test case, but I'm not sure how soon I'll have a result.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "OWNER",
            "body": "What Python version are you using?\r\nIs that with the latest lxml release?\r\nDoes it also fail with the pre-generated C files that lxml ships, i.e. without rerunning Cython?\r\nCould you please provide the complete stack trace of the failure that you get?",
            "created_at": "2017-10-29T06:34:28Z",
            "html_url": "https://github.com/cython/cython/issues/1953#issuecomment-340240961",
            "id": 340240961,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1953",
            "updated_at": "2017-10-29T06:35:24Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/340240961",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "I was able to isolate it now. ðŸŽ‰\r\n\r\nPython 3.6.3, lxml 3.8.0, Cython 0.26.1\r\n\r\n```\r\nPy_Initialize();\r\n\r\nPyObject *pName = PyUnicode_FromString(\"lxml.etree\");\r\n\r\nPyImport_Import(pName);\r\n\r\nPy_Finalize();\r\nPy_Initialize();\r\n\r\nPyImport_Import(pName);\r\nPyErr_Print();\r\n```\r\n\r\n=>\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"src/lxml/etree.pyx\", line 287, in init lxml.etree\r\n    cdef class _TempStore:\r\nAttributeError: type object 'lxml.etree._TempStore' has no attribute '__reduce_cython__'\r\n```\r\n\r\nFrom my previous tests it should be the same for all Cython 0.26 and 0.27 versions while 0.25.2 works.\r\nI did not try other Python versions.\r\nIt does *not* affect lxml 4.0.0. I traced that down to https://github.com/lxml/lxml/commit/3e2967ba64dd21b3eb6aab7024f7b581dda42c8f, so I guess recent versions would show the same issue if you re-enable that \"auto_pickle\" feature.",
            "created_at": "2017-10-29T10:13:30Z",
            "html_url": "https://github.com/cython/cython/issues/1953#issuecomment-340251089",
            "id": 340251089,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1953",
            "updated_at": "2017-10-29T10:15:31Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/340251089",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/464848?v=4",
                "events_url": "https://api.github.com/users/cschramm/events{/privacy}",
                "followers_url": "https://api.github.com/users/cschramm/followers",
                "following_url": "https://api.github.com/users/cschramm/following{/other_user}",
                "gists_url": "https://api.github.com/users/cschramm/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/cschramm",
                "id": 464848,
                "login": "cschramm",
                "organizations_url": "https://api.github.com/users/cschramm/orgs",
                "received_events_url": "https://api.github.com/users/cschramm/received_events",
                "repos_url": "https://api.github.com/users/cschramm/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/cschramm/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/cschramm/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/cschramm"
            }
        },
        {
            "author_association": "OWNER",
            "body": "Thanks for digging up the details. Extension modules  that support reloading are probably still extremely rare. Definitely not lxml. And the support in Cython is still pending (#1715).",
            "created_at": "2017-10-29T19:32:15Z",
            "html_url": "https://github.com/cython/cython/issues/1953#issuecomment-340287774",
            "id": 340287774,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1953",
            "updated_at": "2017-10-29T19:32:15Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/340287774",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "Sad to hear that.\r\n\r\nI'm not 100 % sure what you mean. Multi-phase initialization isn't necessary for extension modules to support reloading, is it? We didn't ever have any issues with reloading lxml up to now (well, there might be hidden memory leaks of course).\r\n\r\nAnyway, now that I know that it's only an issue with lxml (<)= 3.8.0 && Cython >= 0.26.0 it's not a real problem for me (the way to get around it is just to use a recent lxml version if you use a recent Cython version). It would only become a problem again if the lxml project decides to re-enable auto_pickle.",
            "created_at": "2017-10-30T07:34:33Z",
            "html_url": "https://github.com/cython/cython/issues/1953#issuecomment-340364509",
            "id": 340364509,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1953",
            "updated_at": "2017-10-30T07:34:33Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/340364509",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/464848?v=4",
                "events_url": "https://api.github.com/users/cschramm/events{/privacy}",
                "followers_url": "https://api.github.com/users/cschramm/followers",
                "following_url": "https://api.github.com/users/cschramm/following{/other_user}",
                "gists_url": "https://api.github.com/users/cschramm/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/cschramm",
                "id": 464848,
                "login": "cschramm",
                "organizations_url": "https://api.github.com/users/cschramm/orgs",
                "received_events_url": "https://api.github.com/users/cschramm/received_events",
                "repos_url": "https://api.github.com/users/cschramm/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/cschramm/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/cschramm/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/cschramm"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1953/comments",
    "created_at": "2017-10-28T10:48:35Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1953/events",
    "html_url": "https://github.com/cython/cython/issues/1953",
    "id": 269307573,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1953/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1953,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "no attribute __reduce_cython__",
    "updated_at": "2017-10-30T07:34:33Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1953",
    "user": {
        "avatar_url": "https://avatars1.githubusercontent.com/u/464848?v=4",
        "events_url": "https://api.github.com/users/cschramm/events{/privacy}",
        "followers_url": "https://api.github.com/users/cschramm/followers",
        "following_url": "https://api.github.com/users/cschramm/following{/other_user}",
        "gists_url": "https://api.github.com/users/cschramm/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/cschramm",
        "id": 464848,
        "login": "cschramm",
        "organizations_url": "https://api.github.com/users/cschramm/orgs",
        "received_events_url": "https://api.github.com/users/cschramm/received_events",
        "repos_url": "https://api.github.com/users/cschramm/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/cschramm/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cschramm/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/cschramm"
    }
}