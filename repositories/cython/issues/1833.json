{
    "assignee": null,
    "assignees": [],
    "body": "It looks like there's still another memory leak when using a memoryview, though not as serious:\r\n\r\n\r\n```py\r\n# Compile: cythonize -bi a.py\r\n\r\n# Run: python -c 'import a; x.main()'\r\n\r\nfrom cpython cimport array\r\nimport array\r\nimport time\r\nimport psutil\r\n\r\ncdef class X:\r\n\tcdef array.array x\r\n\tcdef double[:] x2\r\n\r\n\tdef __init__(self):\r\n\t\tself.x = array.array('d', [0.0] * 10000)\r\n\t\tself.x2 = self.x # commenting this out prevents the leak\r\n\r\ndef mem():\r\n\tprint str(round(psutil.Process().memory_info().rss/1024./1024., 2)) + ' MB'\r\n\r\ndef main():\r\n\tmem()\r\n\r\n\t# this somehow leaks less memory\r\n\t# for i in xrange(10000):\r\n\t# \tX()\r\n\r\n\t# this leaks memory\r\n\tx = [X() for _ in xrange(10000)]\r\n\tdel x\r\n\r\n\tmem()\r\n\ttime.sleep(1.0)\r\n\tmem()\r\n```\r\n\r\n```\r\n$ rm a.{c,so,html}; cythonize -bi a.pyx && python -c 'import a; a.main()'\r\n...\r\n10.86 MB\r\n70.13 MB\r\n70.13 MB\r\n```",
    "closed_at": "2017-08-22T06:23:39Z",
    "comment_data": [
        {
            "body": "Works for me with current master in Py2 but eats a lot of memory in Py3.",
            "created_at": "2017-08-21T13:23:28Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-323743123",
            "id": 323743123,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-21T13:23:28Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/323743123",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "By \"works for me\", do you mean that you're not experiencing the 10MB -> 70MB mem usage bump with the snippet above?",
            "created_at": "2017-08-21T13:27:06Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-323743837",
            "id": 323743837,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-21T13:27:06Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/323743837",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/17250289?v=4",
                "events_url": "https://api.github.com/users/stefanmh/events{/privacy}",
                "followers_url": "https://api.github.com/users/stefanmh/followers",
                "following_url": "https://api.github.com/users/stefanmh/following{/other_user}",
                "gists_url": "https://api.github.com/users/stefanmh/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/stefanmh",
                "id": 17250289,
                "login": "stefanmh",
                "organizations_url": "https://api.github.com/users/stefanmh/orgs",
                "received_events_url": "https://api.github.com/users/stefanmh/received_events",
                "repos_url": "https://api.github.com/users/stefanmh/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/stefanmh/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/stefanmh/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/stefanmh"
            }
        },
        {
            "body": "No, looks perfect for me in Py2, with only a tiny increase. Which version did you try?",
            "created_at": "2017-08-21T13:31:19Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-323744616",
            "id": 323744616,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-21T13:31:19Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/323744616",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "Ah, it may have been my fault for using the system-wide `cythonize` instead of building the pyx thru `setup.py`. Can now confirm that it doesn't increase very much in Py2, but only in Py3.",
            "created_at": "2017-08-21T13:42:38Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-323746879",
            "id": 323746879,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-21T13:42:38Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/323746879",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/17250289?v=4",
                "events_url": "https://api.github.com/users/stefanmh/events{/privacy}",
                "followers_url": "https://api.github.com/users/stefanmh/followers",
                "following_url": "https://api.github.com/users/stefanmh/following{/other_user}",
                "gists_url": "https://api.github.com/users/stefanmh/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/stefanmh",
                "id": 17250289,
                "login": "stefanmh",
                "organizations_url": "https://api.github.com/users/stefanmh/orgs",
                "received_events_url": "https://api.github.com/users/stefanmh/received_events",
                "repos_url": "https://api.github.com/users/stefanmh/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/stefanmh/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/stefanmh/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/stefanmh"
            }
        },
        {
            "body": "In Py3, the memory does not actually leak but the heap gets fragmented. You can see it if you change your code to this:\r\n```\r\n        # this allocates memory\r\n        x = [X() for _ in xrange(10000)]\r\n        _ = None  # discard latest integer, just in case\r\n        mem()  # larger than what we will see next\r\n        del x\r\n\r\n        mem()  # memory has decreased here\r\n        x = [X() for _ in xrange(1000)]\r\n        mem()  # memory has not increased again, i.e. the heap is fragmented and the new list fits into it\r\n        gc.collect()\r\n        mem()  # no change\r\n\r\n```\r\n",
            "created_at": "2017-08-21T14:51:40Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-323763979",
            "id": 323763979,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-21T14:53:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/323763979",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "Ah, interesting, thanks for investigating! It's pretty weird that this effect only occurs when we do `self.x2 = self.x`. Commenting that line out prevents the memory issue, so the fragmentation can't have been caused by the `array.array`",
            "created_at": "2017-08-21T15:18:55Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-323772252",
            "id": 323772252,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-21T15:18:55Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/323772252",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/17250289?v=4",
                "events_url": "https://api.github.com/users/stefanmh/events{/privacy}",
                "followers_url": "https://api.github.com/users/stefanmh/followers",
                "following_url": "https://api.github.com/users/stefanmh/following{/other_user}",
                "gists_url": "https://api.github.com/users/stefanmh/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/stefanmh",
                "id": 17250289,
                "login": "stefanmh",
                "organizations_url": "https://api.github.com/users/stefanmh/orgs",
                "received_events_url": "https://api.github.com/users/stefanmh/received_events",
                "repos_url": "https://api.github.com/users/stefanmh/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/stefanmh/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/stefanmh/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/stefanmh"
            }
        },
        {
            "body": "I'll close this ticket, assuming that it's actually fixed in master. Please reopen (or file a new ticket) if you find that things (still) don't work on your side.",
            "created_at": "2017-08-22T06:23:39Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-323931030",
            "id": 323931030,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-22T06:23:39Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/323931030",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "Well, the memory still goes to hundreds of megabytes in python3 (using master cython).\r\n\r\nIf the sole cause is indeed memory fragmentation, then maybe not much can be done about it, but I don't *think* that's the only issue here.",
            "created_at": "2017-08-22T14:07:58Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-324037634",
            "id": 324037634,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-22T14:07:58Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/324037634",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/17250289?v=4",
                "events_url": "https://api.github.com/users/stefanmh/events{/privacy}",
                "followers_url": "https://api.github.com/users/stefanmh/followers",
                "following_url": "https://api.github.com/users/stefanmh/following{/other_user}",
                "gists_url": "https://api.github.com/users/stefanmh/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/stefanmh",
                "id": 17250289,
                "login": "stefanmh",
                "organizations_url": "https://api.github.com/users/stefanmh/orgs",
                "received_events_url": "https://api.github.com/users/stefanmh/received_events",
                "repos_url": "https://api.github.com/users/stefanmh/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/stefanmh/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/stefanmh/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/stefanmh"
            }
        },
        {
            "body": "10000 * 10000 * 8 (64 bit double) = 800.000.000, and that's the size of the array data only. sys.getsizeof() says that the size of the list and all of its elements sum up to about 766MB, and the size of the whole process is 781M on my side. That seems pretty good. Somewhere along that way, memory is allocated that does not get freed by discarding the list, maybe an entry in a freelist or something like that.\r\n\r\nOverall, this seems like a very uncommon use case. What application runs for a substantial amount of time and only allocates tons of memory once in its lifetime, just to free it right afterwards? Fragmentation is certainly an issue in CPython, but it's not a big issue for most real-world scenarios.\r\n\r\nI'd be happy to see some evidence that there is something that Cython can do in order to improve this, but until then, I believe that my time is better spent in other corners of the project. I'll happily reopen this ticket if you can provide more insights, e.g. from a Python memory profiler. The mere process size is a rather bad measure for actual memory *usage*.",
            "created_at": "2017-08-22T15:15:43Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-324058721",
            "id": 324058721,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-22T15:15:43Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/324058721",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "body": "Yeah, fair enough.",
            "created_at": "2017-08-22T15:21:50Z",
            "html_url": "https://github.com/cython/cython/issues/1833#issuecomment-324060630",
            "id": 324060630,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1833",
            "updated_at": "2017-08-22T15:21:50Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/324060630",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/17250289?v=4",
                "events_url": "https://api.github.com/users/stefanmh/events{/privacy}",
                "followers_url": "https://api.github.com/users/stefanmh/followers",
                "following_url": "https://api.github.com/users/stefanmh/following{/other_user}",
                "gists_url": "https://api.github.com/users/stefanmh/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/stefanmh",
                "id": 17250289,
                "login": "stefanmh",
                "organizations_url": "https://api.github.com/users/stefanmh/orgs",
                "received_events_url": "https://api.github.com/users/stefanmh/received_events",
                "repos_url": "https://api.github.com/users/stefanmh/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/stefanmh/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/stefanmh/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/stefanmh"
            }
        }
    ],
    "comments": 10,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1833/comments",
    "created_at": "2017-08-21T12:14:59Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2017-08-22T06:23:39Z",
            "event": "closed",
            "id": 1215288446,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1215288446"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1833/events",
    "html_url": "https://github.com/cython/cython/issues/1833",
    "id": 251640828,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1833/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1833,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Another memoryview memory leak",
    "updated_at": "2017-08-22T15:21:50Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1833",
    "user": {
        "avatar_url": "https://avatars3.githubusercontent.com/u/17250289?v=4",
        "events_url": "https://api.github.com/users/stefanmh/events{/privacy}",
        "followers_url": "https://api.github.com/users/stefanmh/followers",
        "following_url": "https://api.github.com/users/stefanmh/following{/other_user}",
        "gists_url": "https://api.github.com/users/stefanmh/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/stefanmh",
        "id": 17250289,
        "login": "stefanmh",
        "organizations_url": "https://api.github.com/users/stefanmh/orgs",
        "received_events_url": "https://api.github.com/users/stefanmh/received_events",
        "repos_url": "https://api.github.com/users/stefanmh/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/stefanmh/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/stefanmh/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/stefanmh"
    }
}