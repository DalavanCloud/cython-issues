{
    "assignee": null,
    "assignees": [],
    "body": "The [docs](http://cython.readthedocs.io/en/latest/src/userguide/wrapping_CPlusPlus.html) say that C++ containers may be iterated over \"Pythonically\" using \"for .. in\" syntax.\r\n\r\nThis works, but only sometimes.  The code that Cython generates is not const-correct.  Further, the code generated differs depending on the type of C++ container, affecting whether or not a function can be marked \"nogil\".\r\n\r\nFully-worked out examples are in this [git repo](https://github.com/molpopgen/CythonCpp), but here is a copy/paste of some Cython code with comments to document the issue:\r\n\r\n~~~{.py}\r\nfrom libcpp.map cimport map\r\nfrom libcpp.vector cimport vector\r\n\r\n#The map cannot be passed in as const,\r\n#otherwise will fail to compile.\r\n#Looking at the generated .cpp\r\n#shows that Cython will declare\r\n#iterator instead of const_iterator\r\n#if foo is passed in as const:\r\n#static unsigned int __pyx_f_10auto_like1_iterate_map(std::map<unsigned int,unsigned int>  const &__pyx_v_foo) {\r\n#  unsigned int __pyx_v_sum1;\r\n#  std::pair<unsigned int,unsigned int>  __pyx_v_i;\r\n#  unsigned int __pyx_r;\r\n#  std::map<unsigned int,unsigned int> ::iterator __pyx_t_1;\r\n#  std::pair<unsigned int,unsigned int>  __pyx_t_2;\r\ncdef unsigned iterate_map(map[unsigned,unsigned] & foo) nogil:\r\n\r\n    cdef unsigned sum1=0\r\n    for i in foo:\r\n        sum1+=i.second\r\n\r\n    return sum1\r\n\r\n#When used with a vector, \r\n#and modeling after the iterate_map function,\r\n#the function must NOT be nogil, else Cython will\r\n#fail to generate a .cpp file...\r\ncdef unsigned iterate_vector(vector[unsigned] & foo):\r\n\r\n    cdef unsigned sum1=0\r\n    #This code is generating PyObject temporaries,\r\n    #but the iterate_map function above correctly \r\n    #generated the pair as the temporary:\r\n    #static unsigned int __pyx_f_10auto_like1_iterate_vector(std::vector<unsigned int>  &__pyx_v_foo) {\r\n    #unsigned int __pyx_v_sum1;\r\n    #PyObject *__pyx_v_i = NULL;\r\n    #unsigned int __pyx_r;\r\n    #__Pyx_RefNannyDeclarations\r\n    #std::vector<unsigned int> ::iterator __pyx_t_1;\r\n    #unsigned int __pyx_t_2;\r\n    #PyObject *__pyx_t_3 = NULL;\r\n    #PyObject *__pyx_t_4 = NULL;\r\n    for i in foo:\r\n        sum1+=i\r\n\r\n    return sum1\r\n\r\n#...unless i gets declared as a cdef variable:\r\ncdef unsigned iterate_vector2(vector[unsigned] & foo) nogil:\r\n\r\n    cdef unsigned sum1=0\r\n    cdef unsigned i\r\n    for i in foo:\r\n        sum1+=i\r\n\r\n    return sum1\r\n~~~\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "body": "Whether the code can be declared \"nogil\" depends solely on the type of the target (loop) variable (which, for integer expressions involving arithmetic, is object to handle potential overflow). \r\n\r\nHowever, `const_iterator` (and hence const overload support) do need to be added to the language to make this work though, might as well [jump into the tar pit](http://yosefk.com/c++fqa/const.html#fqa-18.3). Until then I suppose a const cast is the way to go. ",
            "created_at": "2016-08-28T06:57:29Z",
            "html_url": "https://github.com/cython/cython/issues/1451#issuecomment-242959802",
            "id": 242959802,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1451",
            "updated_at": "2016-08-28T06:57:29Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/242959802",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        },
        {
            "body": "The \"nogil\" thing is weird to me, because I see no reason why Cython should auto-generate a C++ type for the temporary container in one case and a Python type in another.   The case of overflow doesn't seem relevant here, as we are talking about the value_type of an iterator as a temporary variable.   When writing a function in Cython, I'm free to user larger-width variables for arithmetic, but that should be up to me.  For example, I can sum my vector<integer> into a std::uint64_t, etc. And if I want my function to be not-nogil, I can use the Python int type myself.\r\n\r\nThese iterations all have the same common form:\r\n\r\n~~~{.cpp}\r\ncontainer_type::const_iterator i\r\ncontainer_type::const_iterator::value_type temp;\r\nfor(i = foo.begin();i!=foo.end();++i) {\r\n     //not idiomatic, but it'll do.\r\n     const_cast<container_type::iterator::value_type>(temp) = *i;\r\n}\r\n~~~\r\n\r\nDoing different things for different container types, or value_types, seems like it could have weird side-effects.   Change a ctypedef somewhere and suddenly nogil functions will no longer compile.\r\n\r\nSo, I still think that outputting a C++ type for one type of container, and a Python type in a different contest, is an issue.  At the very least, the inconsistency should be documented.  It took a while to work out what was going on and why.\r\n\r\n",
            "created_at": "2016-08-28T16:12:59Z",
            "html_url": "https://github.com/cython/cython/issues/1451#issuecomment-242983135",
            "id": 242983135,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1451",
            "updated_at": "2016-08-28T16:12:59Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/242983135",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6416159?v=3",
                "events_url": "https://api.github.com/users/molpopgen/events{/privacy}",
                "followers_url": "https://api.github.com/users/molpopgen/followers",
                "following_url": "https://api.github.com/users/molpopgen/following{/other_user}",
                "gists_url": "https://api.github.com/users/molpopgen/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/molpopgen",
                "id": 6416159,
                "login": "molpopgen",
                "organizations_url": "https://api.github.com/users/molpopgen/orgs",
                "received_events_url": "https://api.github.com/users/molpopgen/received_events",
                "repos_url": "https://api.github.com/users/molpopgen/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/molpopgen/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/molpopgen/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/molpopgen"
            }
        },
        {
            "body": "I think you're still misunderstanding; the code compiles down to\r\n\r\n```\r\nwhile iter != foo.end():\r\n  i = *iter\r\n  sum1 += i\r\n  ++iter\r\n  ...\r\n```\r\n\r\nThe type of ``i`` is inferred from the type of ``*iter``, the same as if one wrote\r\n\r\n```\r\ni = 3  # or an int-returning function\r\nsum1 += i\r\n```\r\n\r\nThe variable ``i`` may have assignments elsewhere, but for variables used in arithmetic expressions it is unsafe to infer the type to be a C int (due to possible overflow). Any container, even an ``int[]``, whose elements are integers has this property. \r\n\r\nI committed https://github.com/cython/cython/commit/4420cb6eda700ab721b83b843cb0da85e9e6fd3b which should help somewhat. If there's still confusion, or you have better suggestions, it'd be helpful to send an email to cython-users@ which is more suitable for this kind of discussion. ",
            "created_at": "2016-08-29T17:47:10Z",
            "html_url": "https://github.com/cython/cython/issues/1451#issuecomment-243198581",
            "id": 243198581,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1451",
            "updated_at": "2016-08-29T17:47:10Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/243198581",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1451/comments",
    "created_at": "2016-08-26T21:30:58Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2016-08-28T06:58:52Z",
            "event": "renamed",
            "id": 769909660,
            "rename": {
                "from": "Inconsistent code generation for iterating over C++ containers with \"for .. in\" syntax",
                "to": "Iterating over const C++ containers with \"for .. in\" syntax not const correct."
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/769909660"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1451/events",
    "html_url": "https://github.com/cython/cython/issues/1451",
    "id": 173547643,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1451/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1451,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Iterating over const C++ containers with \"for .. in\" syntax not const correct.",
    "updated_at": "2016-08-29T17:47:10Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1451",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/6416159?v=3",
        "events_url": "https://api.github.com/users/molpopgen/events{/privacy}",
        "followers_url": "https://api.github.com/users/molpopgen/followers",
        "following_url": "https://api.github.com/users/molpopgen/following{/other_user}",
        "gists_url": "https://api.github.com/users/molpopgen/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/molpopgen",
        "id": 6416159,
        "login": "molpopgen",
        "organizations_url": "https://api.github.com/users/molpopgen/orgs",
        "received_events_url": "https://api.github.com/users/molpopgen/received_events",
        "repos_url": "https://api.github.com/users/molpopgen/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/molpopgen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/molpopgen/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/molpopgen"
    }
}