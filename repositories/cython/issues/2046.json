{
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "Since 0.27.1, declaring Py_buffer variables in pure-python mode ceased working. This applies to 0.27.1, 0.27.2 and 0.27.3.\r\n\r\n``` python\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    return cython.cast(int, cython.address(pybuf))\r\n\r\nprint f()\r\n```\r\n\r\nI know this isn't really useful code, but it illustrates the issue with a minimal example. I'm getting this error in actual working (with 0.27.0) code.\r\n\r\nWhen compiling with cython 0.27.2 (and .3), gives:\r\n\r\n```\r\n(cython)claudiofreire@klaumpptophp:~> cython buffer_bug.py\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\n                      ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:3:23: Not a type\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    return cython.cast(int, cython.address(pybuf))\r\n                                          ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:5:43: undeclared name not builtin: pybuf\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    return cython.cast(int, cython.address(pybuf))\r\n                                 ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:5:34: Taking address of non-lvalue (type Python object)\r\n```\r\n\r\nIn cython 0.27.0, however, it builds correctly, generating the following code:\r\n\r\n``` C\r\n  __pyx_t_1 = __Pyx_PyInt_From_int(((int)(&__pyx_v_pybuf))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 5, __pyx_L1_error)\r\n  __Pyx_GOTREF(__pyx_t_1);\r\n  __pyx_r = __pyx_t_1;\r\n  __pyx_t_1 = 0;\r\n  goto __pyx_L0;\r\n```\r\n\r\nI could find no directly relatable changes in the commit history, but I'm not that familiar with this code, so maybe someone else can figure this out.\r\n\r\nTo clarify, in non-pure-python mode it works correctly:\r\n\r\n``` python\r\nfrom cpython cimport Py_buffer\r\n\r\ndef f():\r\n    cdef Py_buffer pybuf\r\n    return <int>&pybuf\r\n\r\nprint f()\r\n```\r\n\r\nCompiles in all versions.\r\n\r\nAdding the cimport to buffer_bug.pxd in pure-python mode doesn't change a thing.\r\n\r\nFTR, I realize Py_buffer is unusable in pure python. The use case for this always involves compiled-only code paths:\r\n\r\n``` python\r\nif cython.compiled:\r\n    # do something with Py_buffer\r\nelse:\r\n    # do it the slower pure-python way\r\n```\r\n",
    "closed_at": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2046/comments",
    "created_at": "2017-12-18T16:33:39Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2046/events",
    "html_url": "https://github.com/cython/cython/issues/2046",
    "id": 282941514,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2046/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 2046,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Py_buffer builtin struct unusable after 0.27.0",
    "updated_at": "2017-12-18T16:42:10Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2046",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/1746892?v=4",
        "events_url": "https://api.github.com/users/klaussfreire/events{/privacy}",
        "followers_url": "https://api.github.com/users/klaussfreire/followers",
        "following_url": "https://api.github.com/users/klaussfreire/following{/other_user}",
        "gists_url": "https://api.github.com/users/klaussfreire/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/klaussfreire",
        "id": 1746892,
        "login": "klaussfreire",
        "organizations_url": "https://api.github.com/users/klaussfreire/orgs",
        "received_events_url": "https://api.github.com/users/klaussfreire/received_events",
        "repos_url": "https://api.github.com/users/klaussfreire/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/klaussfreire/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/klaussfreire/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/klaussfreire"
    }
}