{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "This code works as expected: \r\n\r\n    In [17]: %%cython -f\r\n        ...: from libc.string cimport memcpy\r\n        ...:\r\n        ...: DEF KLEN = 5\r\n        ...: DEF TRP_KLEN = KLEN * 3\r\n        ...:\r\n        ...: cdef:\r\n        ...:     unsigned char k[KLEN]\r\n        ...:     unsigned char kk[TRP_KLEN]\r\n        ...: kk = bytearray(b'12345abcde!@#$%')\r\n        ...: memcpy(k, kk + 5, KLEN)\r\n        ...: print(k)\r\n    b'abcde'\r\n\r\nWhile this:\r\n\r\n    In [16]: %%cython -f\r\n        ...: from libc.string cimport memcpy\r\n        ...: \r\n        ...: DEF KLEN = 5\r\n        ...: DEF TRP_KLEN = KLEN * 3\r\n        ...: ctypedef unsigned char SingleKey[KLEN]\r\n        ...: ctypedef unsigned char TripleKey[TRP_KLEN]\r\n        ...: \r\n        ...: cdef:\r\n        ...:     SingleKey k\r\n        ...:     TripleKey kk\r\n        ...: kk = bytearray(b'12345abcde!@#$%')\r\n        ...: memcpy(k, kk + 5, KLEN)\r\n        ...: print(k)\r\n\r\nthrows an error which doesn't directly mention my code:\r\n\r\n    ---------------------------------------------------------------------------\r\n    AssertionError                            Traceback (most recent call last)\r\n    <ipython-input-16-a4bb608248b0> in <module>()\r\n    ----> 1 get_ipython().run_cell_magic('cython', '-f', \"from libc.string cimport memcpy\\n\\nDEF KLEN = 5\\nDEF TRP_KLEN = KLEN * 3\\nctypedef unsigned char SingleKey[KLEN]\\nctypedef unsigned char DoubleKey[TRP_KLEN]\\n\\ncdef:\\n    SingleKey k[KLEN]\\n    DoubleKey kk[TRP_KLEN]\\nkk = bytearray(b'12345abcde!@#$%')\\nmemcpy(&k, &kk[5], KLEN)\\nprint(k)\")\r\n\r\n    /usr/lib/python3.6/site-packages/IPython/core/interactiveshell.py in run_cell_magic(self, magic_name, line, cell)\r\n       2165             magic_arg_s = self.var_expand(line, stack_depth)\r\n       2166             with self.builtin_trap:\r\n    -> 2167                 result = fn(magic_arg_s, cell)\r\n       2168             return result\r\n       2169\r\n\r\n    <decorator-gen-118> in cython(self, line, cell)\r\n\r\n    /usr/lib/python3.6/site-packages/IPython/core/magic.py in <lambda>(f, *a, **k)\r\n        185     # but it's overkill for just that one bit of state.\r\n        186     def magic_deco(arg):\r\n    --> 187         call = lambda f, *a, **k: f(*a, **k)\r\n        188\r\n        189         if callable(arg):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Build/IpythonMagic.py in cython(self, line, cell)\r\n        318         extension = None\r\n        319         if need_cythonize:\r\n    --> 320             extensions = self._cythonize(module_name, code, lib_dir, args, quiet=args.quiet)\r\n        321             assert len(extensions) == 1\r\n        322             extension = extensions[0]\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Build/IpythonMagic.py in _cythonize(self, module_name, code, lib_dir, args, quiet)\r\n        426             elif sys.version_info[0] >= 3:\r\n        427                 opts['language_level'] = 3\r\n    --> 428             return cythonize([extension], **opts)\r\n        429         except CompileError:\r\n        430             return None\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Build/Dependencies.py in cythonize(module_list, exclude, nthreads, aliases, quiet, force, language, exclude_failures, **options)\r\n       1024     if not nthreads:\r\n       1025         for args in to_compile:\r\n    -> 1026             cythonize_one(*args)\r\n       1027\r\n       1028     if exclude_failures:\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Build/Dependencies.py in cythonize_one(pyx_file, c_file, fingerprint, quiet, options, raise_on_failure, embedded_metadata, full_module_name, progress)\r\n       1127     any_failures = 0\r\n       1128     try:\r\n    -> 1129         result = compile_single(pyx_file, options, full_module_name=full_module_name)\r\n       1130         if result.num_errors > 0:\r\n       1131             any_failures = 1\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Main.py in compile_single(source, options, full_module_name)\r\n        647     recursion.\r\n        648     \"\"\"\r\n    --> 649     return run_pipeline(source, options, full_module_name)\r\n        650\r\n        651\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Main.py in run_pipeline(source, options, full_module_name, context)\r\n        497\r\n        498     context.setup_errors(options, result)\r\n    --> 499     err, enddata = Pipeline.run_pipeline(pipeline, source)\r\n        500     context.teardown_errors(err, options, result)\r\n        501     return result\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Pipeline.py in run_pipeline(pipeline, source, printtree)\r\n        352                             exec(\"def %s(phase, data): return phase(data)\" % phase_name, exec_ns)\r\n        353                             run = _pipeline_entry_points[phase_name] = exec_ns[phase_name]\r\n    --> 354                     data = run(phase, data)\r\n        355                     if DebugFlags.debug_verbose_pipeline:\r\n        356                         print(\"    %.3f seconds\" % (time() - t))\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Pipeline.py in run(phase, data)\r\n        332\r\n        333     def run(phase, data):\r\n    --> 334         return phase(data)\r\n        335\r\n        336     error = None\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Pipeline.py in generate_pyx_code_stage(module_node)\r\n         50 def generate_pyx_code_stage_factory(options, result):\r\n         51     def generate_pyx_code_stage(module_node):\r\n    ---> 52         module_node.process_implementation(options, result)\r\n         53         result.compilation_source = module_node.compilation_source\r\n         54         return result\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/ModuleNode.py in process_implementation(self, options, result)\r\n        140         self.find_referenced_modules(env, self.referenced_modules, {})\r\n        141         self.sort_cdef_classes(env)\r\n    --> 142         self.generate_c_code(env, options, result)\r\n        143         self.generate_h_code(env, options, result)\r\n        144         self.generate_api_code(env, options, result)\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/ModuleNode.py in generate_c_code(self, env, options, result)\r\n        376         # generate normal variable and function definitions\r\n        377         self.generate_variable_definitions(env, code)\r\n    --> 378         self.body.generate_function_definitions(env, code)\r\n        379         code.mark_pos(None)\r\n        380         self.generate_typeobj_definitions(env, code)\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_function_definitions(self, env, code)\r\n        436         #print \"StatListNode.generate_function_definitions\" ###\r\n        437         for stat in self.stats:\r\n    --> 438             stat.generate_function_definitions(env, code)\r\n        439\r\n        440     def generate_execution_code(self, code):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_function_definitions(self, env, code)\r\n       9242                 entry.cname = cname\r\n       9243\r\n    -> 9244         self.node.generate_function_definitions(env, code)\r\n       9245\r\n       9246     def generate_execution_code(self, code):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_function_definitions(self, env, code)\r\n       1974         # ----- Function body -----\r\n       1975         # -------------------------\r\n    -> 1976         self.generate_function_body(env, code)\r\n       1977\r\n       1978         code.mark_pos(self.pos, trace=False)\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_function_body(self, env, code)\r\n       1736\r\n       1737     def generate_function_body(self, env, code):\r\n    -> 1738         self.body.generate_execution_code(code)\r\n       1739\r\n       1740     def generate_function_definitions(self, env, code):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_execution_code(self, code)\r\n        442         for stat in self.stats:\r\n        443             code.mark_pos(stat.pos)\r\n    --> 444             stat.generate_execution_code(code)\r\n        445\r\n        446     def annotate(self, code):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_execution_code(self, code)\r\n       6185         for i, if_clause in enumerate(self.if_clauses):\r\n       6186             self._set_branch_hint(if_clause, if_clause.body)\r\n    -> 6187             if_clause.generate_execution_code(code, end_label, is_last=i == last)\r\n       6188         if self.else_clause:\r\n       6189             code.mark_pos(self.else_clause.pos)\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_execution_code(self, code, end_label, is_last)\r\n       6247         self.condition.generate_disposal_code(code)\r\n       6248         self.condition.free_temps(code)\r\n    -> 6249         self.body.generate_execution_code(code)\r\n       6250         code.mark_pos(self.pos, trace=False)\r\n       6251         if not (is_last or self.body.is_terminator):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_execution_code(self, code)\r\n        442         for stat in self.stats:\r\n        443             code.mark_pos(stat.pos)\r\n    --> 444             stat.generate_execution_code(code)\r\n        445\r\n        446     def annotate(self, code):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/UtilNodes.py in generate_execution_code(self, code)\r\n        324     def generate_execution_code(self, code):\r\n        325         self.setup_temp_expr(code)\r\n    --> 326         self.body.generate_execution_code(code)\r\n        327         self.teardown_temp_expr(code)\r\n        328\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_execution_code(self, code)\r\n       6605         self.item.generate_evaluation_code(code)\r\n       6606         self.target.generate_assignment_code(self.item, code)\r\n    -> 6607         self.body.generate_execution_code(code)\r\n       6608         code.mark_pos(self.pos)\r\n       6609         code.put_label(code.continue_label)\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_execution_code(self, code)\r\n        442         for stat in self.stats:\r\n        443             code.mark_pos(stat.pos)\r\n    --> 444             stat.generate_execution_code(code)\r\n        445\r\n        446     def annotate(self, code):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_execution_code(self, code)\r\n       5100     def generate_execution_code(self, code):\r\n       5101         code.mark_pos(self.pos)\r\n    -> 5102         self.generate_rhs_evaluation_code(code)\r\n       5103         self.generate_assignment_code(code)\r\n       5104\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/Nodes.py in generate_rhs_evaluation_code(self, code)\r\n       5387\r\n       5388     def generate_rhs_evaluation_code(self, code):\r\n    -> 5389         self.rhs.generate_evaluation_code(code)\r\n       5390\r\n       5391     def generate_assignment_code(self, code, overloaded_assignment=False):\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/ExprNodes.py in generate_evaluation_code(self, code)\r\n        718             self.allocate_temp_result(code)\r\n        719\r\n    --> 720         self.generate_result_code(code)\r\n        721         if self.is_temp and not (self.type.is_string or self.type.is_pyunicode_ptr):\r\n        722             # If we are temp we do not need to wait until this node is disposed\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/ExprNodes.py in generate_result_code(self, code)\r\n      13135\r\n      13136         code.putln(self.type.from_py_call_code(\r\n    > 13137             self.arg.py_result(), self.result(), self.pos, code, from_py_function=from_py_function))\r\n      13138         if self.type.is_pyobject:\r\n      13139             code.put_gotref(self.py_result())\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/PyrexTypes.py in from_py_call_code(self, source_code, result_code, error_pos, code, from_py_function, error_condition)\r\n        512             source_code, result_code, error_pos, code,\r\n        513             from_py_function or self.from_py_function,\r\n    --> 514             error_condition or self.error_condition(result_code)\r\n        515         )\r\n        516\r\n\r\n    ~/code/lsup/virtualenv/lib/python3.6/site-packages/Cython/Compiler/PyrexTypes.py in from_py_call_code(self, source_code, result_code, error_pos, code, from_py_function, error_condition)\r\n       2481     def from_py_call_code(self, source_code, result_code, error_pos, code,\r\n       2482                           from_py_function=None, error_condition=None):\r\n    -> 2483         assert not error_condition, '%s: %s' % (error_pos, error_condition)\r\n       2484         call_code = \"%s(%s, %s, %s)\" % (\r\n       2485             from_py_function or self.from_py_function,\r\n\r\n    AssertionError: (<StringSourceDescriptor:carray.from_py>, 87, 19): (!__pyx_t_11) && PyErr_Occurred()\r\n\r\nRemoving all ctypedefs for char arrays that were being assigned removed the error, but that seems perfectly legal code. ",
    "closed_at": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2517/comments",
    "created_at": "2018-07-24T22:11:05Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2517/events",
    "html_url": "https://github.com/cython/cython/issues/2517",
    "id": 344222384,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2517/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzNDQyMjIzODQ=",
    "number": 2517,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "ctypedef char array throws obscure error",
    "updated_at": "2018-08-26T04:28:54Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2517",
    "user": {
        "avatar_url": "https://avatars1.githubusercontent.com/u/4306733?v=4",
        "events_url": "https://api.github.com/users/scossu/events{/privacy}",
        "followers_url": "https://api.github.com/users/scossu/followers",
        "following_url": "https://api.github.com/users/scossu/following{/other_user}",
        "gists_url": "https://api.github.com/users/scossu/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/scossu",
        "id": 4306733,
        "login": "scossu",
        "node_id": "MDQ6VXNlcjQzMDY3MzM=",
        "organizations_url": "https://api.github.com/users/scossu/orgs",
        "received_events_url": "https://api.github.com/users/scossu/received_events",
        "repos_url": "https://api.github.com/users/scossu/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/scossu/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scossu/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/scossu"
    }
}