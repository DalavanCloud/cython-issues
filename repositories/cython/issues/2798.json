{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "`prange` seems to hold forever if in the loop we call a function that uses a 1d view of a 2d view. Here is a reproducing example:\r\n\r\n\r\n```python\r\nimport numpy as np\r\nfrom cython.parallel import prange\r\n\r\n\r\ndef wrapper():  # will hold forever\r\n    a = np.random.uniform(0, 100, size=(100, 100)).astype(np.int32)\r\n    g(a)\r\n\r\n\r\ncdef int f(int [:] a_i) nogil:  # uses 1d view\r\n    return 3\r\n\r\n\r\ncdef int g (int [:, :] a) nogil:\r\n\r\n    cdef:\r\n        int i\r\n\r\n    for i in prange(a.shape[0]):  # Works OK with range\r\n        f(a[i])\r\n```\r\n\r\nAs a workaround we can still pass `a` and `i` to `f` and use `a[i]` instead of `a_i`.\r\n\r\nThanks for all the work on Cython!\r\n\r\nVersions:\r\n\r\nCython 0.29.2,\r\nPython 3.7.2",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Thanks for the report, I can reproduce this. My guess is that it dead-locks somehow. Note that you are not freeing the GIL anywhere. I think it's trying to acquire the GIL while it already holds it, or something like that. Ideally, Cython should be able to detect that somehow, but I can't say how difficult that would be.",
            "created_at": "2019-02-02T10:06:45Z",
            "html_url": "https://github.com/cython/cython/issues/2798#issuecomment-459952674",
            "id": 459952674,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2798",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ1OTk1MjY3NA==",
            "updated_at": "2019-02-02T10:06:45Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/459952674",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": ">Note that you are not freeing the GIL anywhere\r\n\r\nJust to make sure, the GIL is implicitly freed when returning to the Python function (`wrapper`), right?",
            "created_at": "2019-02-02T14:56:35Z",
            "html_url": "https://github.com/cython/cython/issues/2798#issuecomment-459971378",
            "id": 459971378,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2798",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ1OTk3MTM3OA==",
            "updated_at": "2019-02-02T14:56:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/459971378",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
                "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
                "followers_url": "https://api.github.com/users/NicolasHug/followers",
                "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
                "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NicolasHug",
                "id": 1190450,
                "login": "NicolasHug",
                "node_id": "MDQ6VXNlcjExOTA0NTA=",
                "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
                "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
                "repos_url": "https://api.github.com/users/NicolasHug/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NicolasHug"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The GIL is a lock. It is held when entering your Python function (which allows you to do Python stuff and call NumPy functions, for example). You declared the `cdef` functions as `nogil`, which means that they _can_ be called without holding the GIL, but it does _not_ release the GIL when entering them. You have to do that yourself, explicitly, either using `with nogil:` somewhere, or by passing `nogil=True` into the `prange()` function.",
            "created_at": "2019-02-02T15:02:31Z",
            "html_url": "https://github.com/cython/cython/issues/2798#issuecomment-459971828",
            "id": 459971828,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2798",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ1OTk3MTgyOA==",
            "updated_at": "2019-02-02T15:02:31Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/459971828",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "I see, thanks a lot for the clarification",
            "created_at": "2019-02-02T15:32:20Z",
            "html_url": "https://github.com/cython/cython/issues/2798#issuecomment-459974086",
            "id": 459974086,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2798",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ1OTk3NDA4Ng==",
            "updated_at": "2019-02-02T15:32:20Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/459974086",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
                "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
                "followers_url": "https://api.github.com/users/NicolasHug/followers",
                "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
                "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NicolasHug",
                "id": 1190450,
                "login": "NicolasHug",
                "node_id": "MDQ6VXNlcjExOTA0NTA=",
                "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
                "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
                "repos_url": "https://api.github.com/users/NicolasHug/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NicolasHug"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2798/comments",
    "created_at": "2019-01-14T02:28:09Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-02-02T10:04:06Z",
            "event": "labeled",
            "id": 2113774333,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIxMTM3NzQzMzM=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2113774333"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-02-02T10:04:06Z",
            "event": "labeled",
            "id": 2113774335,
            "label": {
                "color": "444444",
                "name": "Code Generation"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIxMTM3NzQzMzU=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2113774335"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-02-02T10:04:06Z",
            "event": "labeled",
            "id": 2113774336,
            "label": {
                "color": "444444",
                "name": "Cython Language Feature"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIxMTM3NzQzMzY=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2113774336"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-02-02T10:07:34Z",
            "event": "renamed",
            "id": 2113775543,
            "node_id": "MDE3OlJlbmFtZWRUaXRsZUV2ZW50MjExMzc3NTU0Mw==",
            "rename": {
                "from": "prange holds forever",
                "to": "prange() dead-locks with memoryviews when not freeing the GIL"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/2113775543"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2798/events",
    "html_url": "https://github.com/cython/cython/issues/2798",
    "id": 398729826,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "id": 425556330,
            "name": "Code Generation",
            "node_id": "MDU6TGFiZWw0MjU1NTYzMzA=",
            "url": "https://api.github.com/repos/cython/cython/labels/Code%20Generation"
        },
        {
            "color": "444444",
            "default": false,
            "id": 425559948,
            "name": "Cython Language Feature",
            "node_id": "MDU6TGFiZWw0MjU1NTk5NDg=",
            "url": "https://api.github.com/repos/cython/cython/labels/Cython%20Language%20Feature"
        },
        {
            "color": "444444",
            "default": false,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2798/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzOTg3Mjk4MjY=",
    "number": 2798,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "prange() dead-locks with memoryviews when not freeing the GIL",
    "updated_at": "2019-02-02T15:32:20Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2798",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
        "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
        "followers_url": "https://api.github.com/users/NicolasHug/followers",
        "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
        "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/NicolasHug",
        "id": 1190450,
        "login": "NicolasHug",
        "node_id": "MDQ6VXNlcjExOTA0NTA=",
        "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
        "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
        "repos_url": "https://api.github.com/users/NicolasHug/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/NicolasHug"
    }
}