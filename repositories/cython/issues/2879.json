{
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "Just compiled pandas with cython coverage enabled to test #2871 and got a segfault during the test suite.  This occurs in both master and in 0.29.1, so is not unique to #2871.\r\n\r\nThe test that segfaults is tests/arithmetic/test_datetime64.py TestDatetime64DateOffsetArithmetictest_dt64arr_add_sub_DateOffsets[Index-0-True-BusinessDay].  I'll see if I can track down a smaller piece of code that causes the segfault.  I can reproduce it with\r\n\r\n```\r\nimport pandas as pd\r\nfrom pandas._libs.tslibs import period as libperiod\r\n\r\nts = pd.Timestamp('2000-01-05 00:15:00')\r\nvec = pd.DatetimeIndex([ts])\r\nasper = vec.to_period('B')._data\r\nlibperiod.periodarr_to_dt64arr(asper.asi8, 5000)\r\n```\r\n\r\n`period_to_dt64arr` is mostly a for-loop calling `period_ordinal_to_dt64`, but the latter does not segfault when called on its own:\r\n```\r\nlibperiod.period_ordinal_to_dt64(asper.asi8[0], 5000)\r\n```\r\n\r\nThe offending function:\r\n```\r\n@cython.wraparound(False)\r\n@cython.boundscheck(False)\r\ndef periodarr_to_dt64arr(int64_t[:] periodarr, int freq):\r\n    \"\"\"\r\n    Convert array to datetime64 values from a set of ordinals corresponding to\r\n    periods per period convention.\r\n    \"\"\"\r\n    cdef:\r\n        int64_t[:] out\r\n        Py_ssize_t i, l\r\n\r\n    l = len(periodarr)\r\n\r\n    out = np.empty(l, dtype='i8')\r\n\r\n    with nogil:\r\n        for i in range(l):\r\n            if periodarr[i] == NPY_NAT:\r\n                out[i] = NPY_NAT\r\n                continue\r\n            out[i] = period_ordinal_to_dt64(periodarr[i], freq)\r\n\r\n    return out.base  # .base to access underlying np.ndarray\r\n```",
    "closed_at": "2019-03-03T21:07:27Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Thanks for the report. Looking through the generated code, I could apply a tiny fix to the error handling in the nogil tracing code, although it's unlikely that this was causing your crash since it should only apply to errors raised by the trace function itself.\r\n\r\nIn general, tracing inside of nogil blocks is rather heavy since it needs to acquire and release the GIL around each trace call, which, in the worst case, might also have a behavioural impact. Again, not likely in the given code. Also, it looks like you are not using the ``fast_gil`` directive in pandas, so that's probably unrelated as well.\r\n\r\nI don't see anything else that might be wrong here, so stripping down the example to a self-contained reproducer would help to understand the problem.",
            "created_at": "2019-03-03T11:49:32Z",
            "html_url": "https://github.com/cython/cython/issues/2879#issuecomment-469015272",
            "id": 469015272,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2879",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ2OTAxNTI3Mg==",
            "updated_at": "2019-03-03T11:49:32Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/469015272",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> so stripping down the example to a self-contained reproducer would help to understand the problem.\r\n\r\nI'll give this a go.",
            "created_at": "2019-03-03T16:53:18Z",
            "html_url": "https://github.com/cython/cython/issues/2879#issuecomment-469041139",
            "id": 469041139,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2879",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ2OTA0MTEzOQ==",
            "updated_at": "2019-03-03T16:53:18Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/469041139",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/8078968?v=4",
                "events_url": "https://api.github.com/users/jbrockmendel/events{/privacy}",
                "followers_url": "https://api.github.com/users/jbrockmendel/followers",
                "following_url": "https://api.github.com/users/jbrockmendel/following{/other_user}",
                "gists_url": "https://api.github.com/users/jbrockmendel/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jbrockmendel",
                "id": 8078968,
                "login": "jbrockmendel",
                "node_id": "MDQ6VXNlcjgwNzg5Njg=",
                "organizations_url": "https://api.github.com/users/jbrockmendel/orgs",
                "received_events_url": "https://api.github.com/users/jbrockmendel/received_events",
                "repos_url": "https://api.github.com/users/jbrockmendel/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jbrockmendel/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jbrockmendel/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jbrockmendel"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "OK, I've got a partially stripped-down example and a decent guess as to where the problem lies.  \r\n\r\nTL;DR: several functions in period.pyx that should be marked as `nogil` are not, and somehow this isn't noticed unless coverage is enabled.\r\n\r\nBreaking down `period_to_dt64arr` into its constituent pieces and tearing out pieces not relevant to the example, we can use:\r\n```\r\ndef check(int64_t[:] periodarr):\r\n    cdef:\r\n        ndarray[int64_t] out\r\n        Py_ssize_t i, l\r\n        asfreq_info af_info\r\n        freq_conv_func toDaily = (<freq_conv_func>asfreq_BtoDT)  # <-- the important part, I think\r\n\r\n    l = len(periodarray)\r\n    out = np.empty(l, dtype='i8')\r\n\r\n    with nogil:\r\n       get_asfreq_info(5000, FR_DAY, True, &af_info)\r\n       for i in range(l):\r\n            out[i] = toDaily(periodarr[i], &af_info)\r\n\r\n    return out\r\n```\r\n\r\nand to trigger the segfault we just need `libperiod.check(np.array([0], dtype=np.int64))`\r\n\r\n`freq_conv_func`  is declared as `ctypedef int64_t (*freq_conv_func)(int64_t, asfreq_info*) nogil`, but `asfreq_BtoDT` (and the one function it calls) aren't marked with `nogil`.  Adding those marks tentatively fixes the segfault.\r\n\r\nis this something we would expect cython to have noticed?  Or should this be considered purely user (me) error?",
            "created_at": "2019-03-03T18:32:39Z",
            "html_url": "https://github.com/cython/cython/issues/2879#issuecomment-469050260",
            "id": 469050260,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2879",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ2OTA1MDI2MA==",
            "updated_at": "2019-03-03T18:32:39Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/469050260",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/8078968?v=4",
                "events_url": "https://api.github.com/users/jbrockmendel/events{/privacy}",
                "followers_url": "https://api.github.com/users/jbrockmendel/followers",
                "following_url": "https://api.github.com/users/jbrockmendel/following{/other_user}",
                "gists_url": "https://api.github.com/users/jbrockmendel/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jbrockmendel",
                "id": 8078968,
                "login": "jbrockmendel",
                "node_id": "MDQ6VXNlcjgwNzg5Njg=",
                "organizations_url": "https://api.github.com/users/jbrockmendel/orgs",
                "received_events_url": "https://api.github.com/users/jbrockmendel/received_events",
                "repos_url": "https://api.github.com/users/jbrockmendel/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jbrockmendel/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jbrockmendel/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jbrockmendel"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Thanks for your investigations. Then it's the cast of a function that requires the GIL into a `nogil' function. That is obviously a user error, but Cython should at least warn about it. I'm not sure if it should be an error, because a cast is the intended way for users to say \"I know better\", however unlikely that is in this case. So, I've made it a visible warning for now, with the perspective of making it an error in the future.",
            "created_at": "2019-03-03T21:07:54Z",
            "html_url": "https://github.com/cython/cython/issues/2879#issuecomment-469064357",
            "id": 469064357,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2879",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ2OTA2NDM1Nw==",
            "updated_at": "2019-03-03T21:10:37Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/469064357",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2879/comments",
    "created_at": "2019-03-03T00:03:51Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "e8a9ab94f2334eb57550d0f29a337d230ae1ba88",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/e8a9ab94f2334eb57550d0f29a337d230ae1ba88",
            "created_at": "2019-03-03T11:07:03Z",
            "event": "referenced",
            "id": 2176226030,
            "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDIxNzYyMjYwMzA=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2176226030"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "61505ce492a8060f3458954320a5533d22a87c03",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/61505ce492a8060f3458954320a5533d22a87c03",
            "created_at": "2019-03-03T21:04:49Z",
            "event": "referenced",
            "id": 2176505590,
            "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDIxNzY1MDU1OTA=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2176505590"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "61505ce492a8060f3458954320a5533d22a87c03",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/61505ce492a8060f3458954320a5533d22a87c03",
            "created_at": "2019-03-03T21:07:27Z",
            "event": "closed",
            "id": 2176506794,
            "node_id": "MDExOkNsb3NlZEV2ZW50MjE3NjUwNjc5NA==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2176506794"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-03-03T21:08:19Z",
            "event": "labeled",
            "id": 2176507272,
            "label": {
                "color": "444444",
                "name": "enhancement"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIxNzY1MDcyNzI=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2176507272"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-03-03T21:08:19Z",
            "event": "labeled",
            "id": 2176507273,
            "label": {
                "color": "444444",
                "name": "Error Reporting"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIxNzY1MDcyNzM=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2176507273"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-03-03T21:08:23Z",
            "event": "milestoned",
            "id": 2176507292,
            "milestone": {
                "title": "0.29.7"
            },
            "node_id": "MDE1Ok1pbGVzdG9uZWRFdmVudDIxNzY1MDcyOTI=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2176507292"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2879/events",
    "html_url": "https://github.com/cython/cython/issues/2879",
    "id": 416456187,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "id": 425557478,
            "name": "Error Reporting",
            "node_id": "MDU6TGFiZWw0MjU1NTc0Nzg=",
            "url": "https://api.github.com/repos/cython/cython/labels/Error%20Reporting"
        },
        {
            "color": "444444",
            "default": true,
            "id": 425556243,
            "name": "enhancement",
            "node_id": "MDU6TGFiZWw0MjU1NTYyNDM=",
            "url": "https://api.github.com/repos/cython/cython/labels/enhancement"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2879/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 5,
        "created_at": "2019-03-01T17:12:36Z",
        "creator": {
            "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
            "events_url": "https://api.github.com/users/scoder/events{/privacy}",
            "followers_url": "https://api.github.com/users/scoder/followers",
            "following_url": "https://api.github.com/users/scoder/following{/other_user}",
            "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/scoder",
            "id": 491659,
            "login": "scoder",
            "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
            "organizations_url": "https://api.github.com/users/scoder/orgs",
            "received_events_url": "https://api.github.com/users/scoder/received_events",
            "repos_url": "https://api.github.com/users/scoder/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/scoder"
        },
        "description": null,
        "due_on": null,
        "html_url": "https://github.com/cython/cython/milestone/66",
        "id": 4100473,
        "labels_url": "https://api.github.com/repos/cython/cython/milestones/66/labels",
        "node_id": "MDk6TWlsZXN0b25lNDEwMDQ3Mw==",
        "number": 66,
        "open_issues": 0,
        "state": "open",
        "title": "0.29.7",
        "updated_at": "2019-03-04T14:56:56Z",
        "url": "https://api.github.com/repos/cython/cython/milestones/66"
    },
    "node_id": "MDU6SXNzdWU0MTY0NTYxODc=",
    "number": 2879,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Coverage Plugin causes segfault",
    "updated_at": "2019-03-03T21:10:37Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2879",
    "user": {
        "avatar_url": "https://avatars1.githubusercontent.com/u/8078968?v=4",
        "events_url": "https://api.github.com/users/jbrockmendel/events{/privacy}",
        "followers_url": "https://api.github.com/users/jbrockmendel/followers",
        "following_url": "https://api.github.com/users/jbrockmendel/following{/other_user}",
        "gists_url": "https://api.github.com/users/jbrockmendel/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jbrockmendel",
        "id": 8078968,
        "login": "jbrockmendel",
        "node_id": "MDQ6VXNlcjgwNzg5Njg=",
        "organizations_url": "https://api.github.com/users/jbrockmendel/orgs",
        "received_events_url": "https://api.github.com/users/jbrockmendel/received_events",
        "repos_url": "https://api.github.com/users/jbrockmendel/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jbrockmendel/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jbrockmendel/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jbrockmendel"
    }
}