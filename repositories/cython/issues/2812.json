{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "I created a simple cpp class that hold a reference to a std:string\r\n\r\n```cpp\r\n#include <string>\r\n\r\nnamespace test {\r\n    class Test {\r\n        private:\r\n            const std::string &m_string;\r\n\r\n        public:\r\n            Test(const std::string& s): m_string{s} {}\r\n            const std::string get_string() { return m_string; }\r\n    };\r\n}\r\n```\r\n\r\nand I'm using it inside a cython generator as follow:\r\n```cython\r\n# distutils: language = c++\r\n# cython: language_level=3str\r\n\r\nfrom libcpp.string cimport string\r\n\r\ncdef extern from \"cpp_class.h\" namespace \"test\":\r\n    cdef cppclass Test:\r\n        Test(string)\r\n        string get_string()\r\n\r\ndef iter_test_implicit(bytes bb):\r\n    cdef Test *t = new Test(bb)  # implicit bytes to std::string conversion here\r\n    yield t.get_string()\r\n    yield t.get_string()\r\n    del t\r\n```\r\n\r\nIf I iterate over `iter_test_implicit` from python I get:\r\n\r\n```\r\nb'test'\r\nb''\r\n```\r\n\r\nI would expect it to print twice the test string, but the second yielded item returns an empty string. I assume that the referenced string get lost after the generator resume..\r\nIf I explicitly do the conversion from python bytes to std::string everything works fine:\r\n```cython\r\ndef iter_test_explicit(bytes bb):\r\n    cdef string st = bb    # explicit conversion here\r\n    cdef Test *t = new Test(st)\r\n    yield t.get_string()\r\n    yield t.get_string()\r\n    del t\r\n```\r\n\r\nand the output is as expected:\r\n```\r\nb'test'\r\nb'test'\r\n```\r\n\r\nFull code [example.zip](https://github.com/cython/cython/files/2786551/example.zip)\r\n",
    "closed_at": "2019-01-23T21:01:48Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "You are storing the reference to a temporarily created C++ string object in the `Test` class that Cython created for you. That means that Cython owns it, and it deallocates it after use. In this case, it gets allocated on the C stack and cleaned up on the first yield.\r\n\r\nBy assigning it to an explicit local variable in your second example, it becomes part of the generator closure, which stays alive across yields. This is the right way to handle it.",
            "created_at": "2019-01-23T21:01:48Z",
            "html_url": "https://github.com/cython/cython/issues/2812#issuecomment-456964576",
            "id": 456964576,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2812",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ1Njk2NDU3Ng==",
            "updated_at": "2019-01-23T21:01:48Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/456964576",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2812/comments",
    "created_at": "2019-01-23T09:43:56Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-01-23T21:01:48Z",
            "event": "closed",
            "id": 2092827599,
            "node_id": "MDExOkNsb3NlZEV2ZW50MjA5MjgyNzU5OQ==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2092827599"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-01-23T21:02:06Z",
            "event": "labeled",
            "id": 2092828213,
            "label": {
                "color": "f9d0c4",
                "name": "C++"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIwOTI4MjgyMTM=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2092828213"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-01-23T21:02:06Z",
            "event": "labeled",
            "id": 2092828217,
            "label": {
                "color": "444444",
                "name": "R: worksforme"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIwOTI4MjgyMTc=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2092828217"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2812/events",
    "html_url": "https://github.com/cython/cython/issues/2812",
    "id": 402151237,
    "labels": [
        {
            "color": "f9d0c4",
            "default": false,
            "id": 414805136,
            "name": "C++",
            "node_id": "MDU6TGFiZWw0MTQ4MDUxMzY=",
            "url": "https://api.github.com/repos/cython/cython/labels/C++"
        },
        {
            "color": "444444",
            "default": false,
            "id": 425556354,
            "name": "R: worksforme",
            "node_id": "MDU6TGFiZWw0MjU1NTYzNTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20worksforme"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2812/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU0MDIxNTEyMzc=",
    "number": 2812,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Generator and implicit casting bug ",
    "updated_at": "2019-01-23T21:02:06Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2812",
    "user": {
        "avatar_url": "https://avatars3.githubusercontent.com/u/12676820?v=4",
        "events_url": "https://api.github.com/users/gtsystem/events{/privacy}",
        "followers_url": "https://api.github.com/users/gtsystem/followers",
        "following_url": "https://api.github.com/users/gtsystem/following{/other_user}",
        "gists_url": "https://api.github.com/users/gtsystem/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/gtsystem",
        "id": 12676820,
        "login": "gtsystem",
        "node_id": "MDQ6VXNlcjEyNjc2ODIw",
        "organizations_url": "https://api.github.com/users/gtsystem/orgs",
        "received_events_url": "https://api.github.com/users/gtsystem/received_events",
        "repos_url": "https://api.github.com/users/gtsystem/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/gtsystem/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/gtsystem/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/gtsystem"
    }
}