{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "I'm getting different results between Cython and its equivalent Python code. I've checked and re-checked my code, but I do not have the skill to debug Cython yet, and reduce it to a more minimal example. I've consulted [DavidW on SO](https://stackoverflow.com/questions/48486358/cython-code-doesnt-match-equivalent-python-code), he took a couple guesses but couldn't locate the issue.\r\n\r\nHe also posted an answer that turned out to be irrelevant.\r\n```cython\r\ndef cywhere(np.ndarray a not None, np.ndarray b not None):\r\n    a = a.astype(dtype=np.int64)\r\n    b = a.astype(dtype=np.int64)\r\n\r\n    a_ind, b_ind = cywhere_wrapped(a, b)\r\n\r\n    a_ind = a_ind.astype(np.min_scalar_type(a.shape[0]))\r\n    b_ind = b_ind.astype(np.min_scalar_type(b.shape[0]))\r\n\r\n    return a_ind, b_ind\r\n\r\n@cython.boundscheck(False)\r\n@cython.wraparound(False)\r\ncdef cywhere_wrapped(np.ndarray[int64_t] a, np.ndarray[int64_t] b):\r\n    cdef vector[int64_t] a_ind = vector[int64_t]()\r\n    cdef vector[int64_t] b_ind = vector[int64_t]()\r\n    cdef int64_t na = a.shape[0], nb = b.shape[0]\r\n    cdef int64_t ia, ib\r\n    cdef int64_t j\r\n    cdef int64_t match = 0\r\n\r\n    for ia in range(na):\r\n        j = a[ia]\r\n        ib = match\r\n        while ib < nb and j >= b[ib]:\r\n            if j == b[ib]:\r\n                a_ind.push_back(ia)\r\n                b_ind.push_back(ib)\r\n                if b[match] < b[ib]:\r\n                    match = ib\r\n\r\n            cython.operator.preincrement(ib)\r\n\r\n    return vector_to_np(a_ind), vector_to_np(b_ind)\r\n\r\n@cython.boundscheck(False)\r\n@cython.wraparound(False)\r\ncdef vector_to_np(vector[int64_t]& vec):\r\n    cdef np.ndarray[int64_t, ndim=1] arr = np.empty(vec.size(), dtype=np.int64)\r\n\r\n    cdef void* arr_p = <void*> arr.data\r\n    cdef void* vec_p = <void*> &vec[0]\r\n\r\n    memcpy(arr_p, vec_p, sizeof(int64_t) * vec.size())\r\n\r\n    return arr\r\n\r\ndef pywhere(a, b):\r\n    a_ind, b_ind = [], []\r\n    match = 0\r\n    for ia, j in enumerate(a):\r\n        ib = match\r\n        while ib < len(b) and j >= b[ib]:\r\n            if j == b[ib]:\r\n                a_ind.append(ia)\r\n                b_ind.append(ib)\r\n                if b[match] < b[ib]:\r\n                    match = ib\r\n            ib += 1\r\n\r\n    return a_ind, b_ind\r\n```\r\n\r\nExample input:\r\n```python\r\na = np.asarray([1, 2, 2, 3])\r\nb = np.asarray([0, 2, 2, 3, 4])\r\n\r\na_idx, b_idx = cywhere(a, b) # Or pywhere\r\nprint(repr(a_idx))\r\nprint(repr(b_idx))\r\n```\r\n\r\nExample output:\r\n```python\r\n# cywhere\r\narray([0, 1, 1, 2, 2, 3], dtype=uint8)\r\narray([0, 1, 2, 1, 2, 3], dtype=uint8)\r\n\r\n# pywhere\r\n[1, 1, 2, 2, 3]\r\n[1, 2, 1, 2, 3]\r\n```",
    "closed_at": "2018-01-28T16:55:40Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "I have tried:\r\n\r\n1. Trying to replace `preincrement` by `+= 1`\r\n2. Commenting the `for` loop. (empty arrays as expected)\r\n3. Adding hardcoded values to the `vector`s to make sure the conversion is okay.\r\n4. Reading, re-reading, and making sure the two versions are logically equivalent.\r\n\r\nEdit: [You can see the full code here.](https://github.com/hameerabbasi/sparse/tree/cython-speedups)",
            "created_at": "2018-01-28T16:39:13Z",
            "html_url": "https://github.com/cython/cython/issues/2085#issuecomment-361076179",
            "id": 361076179,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2085",
            "updated_at": "2018-01-28T16:43:32Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/361076179",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/2190658?v=4",
                "events_url": "https://api.github.com/users/hameerabbasi/events{/privacy}",
                "followers_url": "https://api.github.com/users/hameerabbasi/followers",
                "following_url": "https://api.github.com/users/hameerabbasi/following{/other_user}",
                "gists_url": "https://api.github.com/users/hameerabbasi/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/hameerabbasi",
                "id": 2190658,
                "login": "hameerabbasi",
                "organizations_url": "https://api.github.com/users/hameerabbasi/orgs",
                "received_events_url": "https://api.github.com/users/hameerabbasi/received_events",
                "repos_url": "https://api.github.com/users/hameerabbasi/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/hameerabbasi/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/hameerabbasi/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/hameerabbasi"
            }
        },
        {
            "author_association": "OWNER",
            "body": "To be discussed on the users mailing list.",
            "created_at": "2018-01-28T16:55:40Z",
            "html_url": "https://github.com/cython/cython/issues/2085#issuecomment-361077476",
            "id": 361077476,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2085",
            "updated_at": "2018-01-28T16:55:40Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/361077476",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2085/comments",
    "created_at": "2018-01-28T16:36:17Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-01-28T16:55:26Z",
            "event": "labeled",
            "id": 1445258659,
            "label": {
                "color": "fef2c0",
                "name": "support question"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/1445258659"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-01-28T16:55:40Z",
            "event": "closed",
            "id": 1445258762,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1445258762"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2085/events",
    "html_url": "https://github.com/cython/cython/issues/2085",
    "id": 292218161,
    "labels": [
        {
            "color": "fef2c0",
            "default": false,
            "id": 414800623,
            "name": "support question",
            "url": "https://api.github.com/repos/cython/cython/labels/support%20question"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2085/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 2085,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Inconsistent results between Cython and equivalent Python code.",
    "updated_at": "2018-01-28T16:55:40Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2085",
    "user": {
        "avatar_url": "https://avatars3.githubusercontent.com/u/2190658?v=4",
        "events_url": "https://api.github.com/users/hameerabbasi/events{/privacy}",
        "followers_url": "https://api.github.com/users/hameerabbasi/followers",
        "following_url": "https://api.github.com/users/hameerabbasi/following{/other_user}",
        "gists_url": "https://api.github.com/users/hameerabbasi/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/hameerabbasi",
        "id": 2190658,
        "login": "hameerabbasi",
        "organizations_url": "https://api.github.com/users/hameerabbasi/orgs",
        "received_events_url": "https://api.github.com/users/hameerabbasi/received_events",
        "repos_url": "https://api.github.com/users/hameerabbasi/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/hameerabbasi/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hameerabbasi/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/hameerabbasi"
    }
}