{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Hi All, \r\n\r\nI'm trying to reduce the packaged size of the scientific computing ecosystem to make it friendlier for distributed deployments using tools like docker, kubernetes, etc..  An issue for this topic generally is here: https://github.com/ContinuumIO/anaconda-issues/issues/8242\r\n\r\nOne important issue that came up from @mingwandroid relates to Cython, see https://github.com/ContinuumIO/anaconda-issues/issues/8242#issuecomment-359524128\r\n\r\n> It seems the shared libraries are chock full of instruction code\r\n\r\n> PyInit_cython_special is huge; more than 1MB.\r\n\r\n> why all of these movq instructions are not being coalesced into a memset.\r\n\r\nIn a separate conversation he said the following:\r\n\r\n> Now ideally you'd like your compiler to be smart enough to coalesce all those clears over the whole object into 1 memset, and then even better, put them all together so that a single memset could do it.\r\n> the package size on disk is swamped by the instructions to do these clears!\r\n> instead of a call to a function to memset it's a huge amount of instructions, like tens of thousands.\r\n> and that takes space on the extension module text segment.\r\n\r\nTo be honest, I don't have much expertise here, but I thought I'd raise an issue here in case this sort of problem can be resolved within Cython, or, if not, if anyone here has any additional helpful thoughts. \r\n\r\nThank you all for your time.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "OWNER",
            "body": "Thanks for bringing this up. As a quick improvement, I enabled `-Os` (optimise for size instead of speed) only for the module init function, and only under gcc for now. For a couple of arbitrarily chosen, -O3 compiled and stripped .py modules, the total .so file size reduction that I could see was 0-3%. So, not useless, but also not impressive. More of a \"no reason not to do it\" kind of improvement. You can add `-DCYTHON_SMALL_CODE=` to your CFLAGS to disable it and see the difference.\r\n\r\nI can't say without further investigation what all those `movq` commands do, but the module init function does a lot of initialisations of various objects, variables and structures. Probably worth taking a look, but it's not necessarily just \"stupid code\". The C code is most likely easier to analyse than the assembly.",
            "created_at": "2018-02-14T20:45:49Z",
            "html_url": "https://github.com/cython/cython/issues/2102#issuecomment-365739623",
            "id": 365739623,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2102",
            "updated_at": "2018-02-14T20:45:49Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/365739623",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "OWNER",
            "body": "@mingwandroid, would it be possible for you to figure out what generated C code leads to those ``movq`` instructions that were mentioned over in the anaconda ticket? Compiling with debug symbols might give some hints.",
            "created_at": "2018-02-16T20:27:13Z",
            "html_url": "https://github.com/cython/cython/issues/2102#issuecomment-366349071",
            "id": 366349071,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2102",
            "updated_at": "2018-02-16T20:27:13Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/366349071",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "OWNER",
            "body": "I disassembled another module now that I had lying around, and I think those ``movq`` series are simply the initialisation of local (temp) variables. The module init function in question just happens to have many of them. But the size is certainly dominated by the actual code, not the variable initialisation. So this is not an interesting track.",
            "created_at": "2018-02-16T20:45:38Z",
            "html_url": "https://github.com/cython/cython/issues/2102#issuecomment-366353437",
            "id": 366353437,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2102",
            "updated_at": "2018-02-16T20:45:38Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/366353437",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "@scoder thank you for spending the time to look into this.  I appreciate it. \r\n\r\nBroadening out my question a bit, it seems like libraries that make heavy use of Cython tend to have large binaries (~10-50MB).  Are there things that can be done from within Cython to improve this situation?",
            "created_at": "2018-02-16T20:51:50Z",
            "html_url": "https://github.com/cython/cython/issues/2102#issuecomment-366354800",
            "id": 366354800,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2102",
            "updated_at": "2018-02-16T20:51:50Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/366354800",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/306380?v=4",
                "events_url": "https://api.github.com/users/mrocklin/events{/privacy}",
                "followers_url": "https://api.github.com/users/mrocklin/followers",
                "following_url": "https://api.github.com/users/mrocklin/following{/other_user}",
                "gists_url": "https://api.github.com/users/mrocklin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mrocklin",
                "id": 306380,
                "login": "mrocklin",
                "organizations_url": "https://api.github.com/users/mrocklin/orgs",
                "received_events_url": "https://api.github.com/users/mrocklin/received_events",
                "repos_url": "https://api.github.com/users/mrocklin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mrocklin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mrocklin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mrocklin"
            }
        },
        {
            "author_association": "OWNER",
            "body": "Cython definitely generates a lot of C code and widely uses inline functions that result in even larger assembly code size. That's partly where the performance comes from. I can certainly see an argument for reducing the code optimisation inside of the module init function. I doubt that this would have a measurable negative impact on the import time, and it might even have a positive effect due to smaller modules.\r\n\r\nI disabled method unpacking in module level code now, which gives another bit of size reduction, depending on the number of function calls at the module level.\r\n\r\nWe also considered a special \"optimise for size\" directive in Cython, but let's face it, you can't beat Python bytecode when it comes to size, so the best you can do if you want small modules is to *not* compile them, or at least not all of their code. (Although, now that I write this - Cython could obviously do that, too, i.e. it could detect longer pure Python code sections in the module init code and output them as interpreted Python code ... Probably not something to implement tonight... And also not to be done lightly, because it would call the Python parser, compiler and interpreter at runtime, which is a huge overhead...)",
            "created_at": "2018-02-16T21:47:46Z",
            "html_url": "https://github.com/cython/cython/issues/2102#issuecomment-366367704",
            "id": 366367704,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2102",
            "updated_at": "2018-02-16T21:51:00Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/366367704",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2102/comments",
    "created_at": "2018-02-14T18:00:03Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/1042804?v=4",
                "events_url": "https://api.github.com/users/mingwandroid/events{/privacy}",
                "followers_url": "https://api.github.com/users/mingwandroid/followers",
                "following_url": "https://api.github.com/users/mingwandroid/following{/other_user}",
                "gists_url": "https://api.github.com/users/mingwandroid/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mingwandroid",
                "id": 1042804,
                "login": "mingwandroid",
                "organizations_url": "https://api.github.com/users/mingwandroid/orgs",
                "received_events_url": "https://api.github.com/users/mingwandroid/received_events",
                "repos_url": "https://api.github.com/users/mingwandroid/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mingwandroid/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mingwandroid/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mingwandroid"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-02-14T18:00:03Z",
            "event": "mentioned",
            "id": 1474361416,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1474361416"
        },
        {
            "actor": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/1042804?v=4",
                "events_url": "https://api.github.com/users/mingwandroid/events{/privacy}",
                "followers_url": "https://api.github.com/users/mingwandroid/followers",
                "following_url": "https://api.github.com/users/mingwandroid/following{/other_user}",
                "gists_url": "https://api.github.com/users/mingwandroid/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mingwandroid",
                "id": 1042804,
                "login": "mingwandroid",
                "organizations_url": "https://api.github.com/users/mingwandroid/orgs",
                "received_events_url": "https://api.github.com/users/mingwandroid/received_events",
                "repos_url": "https://api.github.com/users/mingwandroid/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mingwandroid/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mingwandroid/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mingwandroid"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-02-14T18:00:03Z",
            "event": "subscribed",
            "id": 1474361420,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1474361420"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "969765b6b9f22d5bae6206ff1ce0055f116bce94",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/969765b6b9f22d5bae6206ff1ce0055f116bce94",
            "created_at": "2018-02-14T18:36:18Z",
            "event": "referenced",
            "id": 1474429171,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1474429171"
        },
        {
            "actor": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/1042804?v=4",
                "events_url": "https://api.github.com/users/mingwandroid/events{/privacy}",
                "followers_url": "https://api.github.com/users/mingwandroid/followers",
                "following_url": "https://api.github.com/users/mingwandroid/following{/other_user}",
                "gists_url": "https://api.github.com/users/mingwandroid/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mingwandroid",
                "id": 1042804,
                "login": "mingwandroid",
                "organizations_url": "https://api.github.com/users/mingwandroid/orgs",
                "received_events_url": "https://api.github.com/users/mingwandroid/received_events",
                "repos_url": "https://api.github.com/users/mingwandroid/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mingwandroid/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mingwandroid/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mingwandroid"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-02-16T20:27:13Z",
            "event": "mentioned",
            "id": 1478627550,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1478627550"
        },
        {
            "actor": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/1042804?v=4",
                "events_url": "https://api.github.com/users/mingwandroid/events{/privacy}",
                "followers_url": "https://api.github.com/users/mingwandroid/followers",
                "following_url": "https://api.github.com/users/mingwandroid/following{/other_user}",
                "gists_url": "https://api.github.com/users/mingwandroid/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mingwandroid",
                "id": 1042804,
                "login": "mingwandroid",
                "organizations_url": "https://api.github.com/users/mingwandroid/orgs",
                "received_events_url": "https://api.github.com/users/mingwandroid/received_events",
                "repos_url": "https://api.github.com/users/mingwandroid/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mingwandroid/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mingwandroid/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mingwandroid"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-02-16T20:27:13Z",
            "event": "subscribed",
            "id": 1478627551,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1478627551"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-02-16T20:51:50Z",
            "event": "mentioned",
            "id": 1478664708,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1478664708"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-02-16T20:51:50Z",
            "event": "subscribed",
            "id": 1478664711,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1478664711"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "63cd3bbb5eac22b92808eeb90b512359e3def20a",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/63cd3bbb5eac22b92808eeb90b512359e3def20a",
            "created_at": "2018-02-16T21:31:41Z",
            "event": "referenced",
            "id": 1478723801,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1478723801"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "784722dadb515ad69179cb35ae54315ec4aa37a5",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/784722dadb515ad69179cb35ae54315ec4aa37a5",
            "created_at": "2018-02-16T22:03:09Z",
            "event": "referenced",
            "id": 1478768525,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1478768525"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2102/events",
    "html_url": "https://github.com/cython/cython/issues/2102",
    "id": 297190754,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2102/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 2102,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Large output size of compiled code",
    "updated_at": "2018-02-16T21:51:00Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2102",
    "user": {
        "avatar_url": "https://avatars3.githubusercontent.com/u/306380?v=4",
        "events_url": "https://api.github.com/users/mrocklin/events{/privacy}",
        "followers_url": "https://api.github.com/users/mrocklin/followers",
        "following_url": "https://api.github.com/users/mrocklin/following{/other_user}",
        "gists_url": "https://api.github.com/users/mrocklin/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mrocklin",
        "id": 306380,
        "login": "mrocklin",
        "organizations_url": "https://api.github.com/users/mrocklin/orgs",
        "received_events_url": "https://api.github.com/users/mrocklin/received_events",
        "repos_url": "https://api.github.com/users/mrocklin/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mrocklin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mrocklin/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mrocklin"
    }
}