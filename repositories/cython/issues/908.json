{
    "assignee": null,
    "assignees": [],
    "body": "There is a problem where Cython is not properly handling tstate->exc_* in exception handlers.\nThe \"global\" exception (tstate->exc_*) does not get cleared properly in an exception handler that raises a different exception.\n\nStarting from an example, put the following into a pyx_leak.pyx file:\n\n\n```\ndef foo():\n    try:\n        raise TypeError\n    except TypeError:\n        raise ValueError\n```\n\nAnd then from .py (or the prompt), do this:\n\n```\nimport pyx_leak\nimport sys\n\ndef bar():\n    try:\n        pyx_leak.foo()\n    except ValueError:\n        pass\n\nbar()\nprint sys.exc_info()\n```\n\nWhen you run this, you'll see that after calling bar, the `TypeError` exception is still set as the \"global\" exception.\nThe inner exception should not be leaking its way out (with normal Python, sys.exc_info() should return all None).\n\nI'm not entirely certain what the correct way to handle this is.  Looking at the generated code:\n\n\n```\n      __Pyx_Raise(__pyx_builtin_ValueError, 0, 0);\n      {__pyx_filename = __pyx_f[0]; __pyx_lineno = 5; __pyx_clineno = __LINE__; goto __pyx_L7_except_error;}\n      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;\n      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;\n      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;\n      goto __pyx_L6_exception_handled;\n    }\n    __pyx_L7_except_error:;\n    __Pyx_XDECREF(__pyx_save_exc_type);\n    __Pyx_XDECREF(__pyx_save_exc_value);\n    __Pyx_XDECREF(__pyx_save_exc_tb);\n    goto __pyx_L1_error;\n    __pyx_L6_exception_handled:;\n    __Pyx_XGIVEREF(__pyx_save_exc_type);\n    __Pyx_XGIVEREF(__pyx_save_exc_value);\n    __Pyx_XGIVEREF(__pyx_save_exc_tb);\n    __Pyx_ExceptionReset(__pyx_save_exc_type, __pyx_save_exc_value, __pyx_save_exc_tb);\n    __pyx_L12_try_end:;\n  }\n\n  __pyx_r = Py_None; __Pyx_INCREF(Py_None);\n  goto __pyx_L0;\n  __pyx_L1_error:;\n  __Pyx_XDECREF(__pyx_t_1);\n  __Pyx_XDECREF(__pyx_t_2);\n  __Pyx_XDECREF(__pyx_t_3);\n  __Pyx_AddTraceback(\"pyx_leak2.foo\");\n  __pyx_r = NULL;\n  __pyx_L0:;\n  __Pyx_XGIVEREF(__pyx_r);\n  __Pyx_FinishRefcountContext();\n  return __pyx_r;\n}\n```\n\nYou can see that raising `ValueError` does a jump to `__pyx_L7_except_error` (and oddly, the next 4 lines are unreachable).\nThen it jumps to `__pyx_L1_error`.  I think this is the critical problem.  If the `__Pyx_ExceptionReset` block of code was\nexecuted, then I think (maybe) this problem would go away.\n\nAs a side note, I think this problem was introduced by the change mentioned in ticket http://trac.cython.org/ticket/228.\nPreviously, `__Pyx_Raise` would set `tstate->exc_*` to NULL (which in this case is the inner `TypeError`).\nTechnically, I don't think that's the correct behavior (doing the `__Pyx_ExceptionReset` after `__Pyx_Raise` seems more correct to me when I compare it to CPython's implementation).\n\nThis is a problem for long-lived Python functions that make calls into Cython code which raise exceptions.\nThe \"global\" exception stays live for much too long.\n\nJust FYI, I've been researching this for a while.  If you're curious, here's CPython's behavior in the exception handler:\n\n```\nPyTraceback_Here()\nPyErr_Fetch() # curexc->local variable\nset_exc_info()\n\ttstate->exc_type = None\n\tframe->f_exc_type = tstate->exc_type # Which is None\n\ttstate->exc_* = local variable (TypeError)\ndo_raise()\n\tPyErr_Restore()\n\t\ttstate->curexc_* = ValueError\nPyTraceback_Here()\nreset_exc_info()\n\ttstate->exc_* = frame->f_exc_* (which is None)\n\tframe->f_exc_* = NULL\npop frame\n```\n\nCompared to Cython's behavior:\n\n```\n__Pyx_AddTraceback()\n__Pyx_GetException()\t\n\tMove tstate->curexc_* to tstate->exc_* (which is TypeError)\n__Pyx_Raise()\n\t__Pyx_ErrRestore()\n\t\ttstate->curexc_* = ValueError\n__Pyx_AddTraceback()\n# NOTE: Critical error here, tstate->exc_* is still TypeError\nReturn NULL\n```\n\nI may take a look at a fix for this next week, but I am completely unfamiliar with how the compiler works, so I may not have time for it.  I would really appreciate if anyone who is familiar with this to give any pointers or thoughts.\n\nMigrated from http://trac.cython.org/ticket/346",
    "closed_at": "2009-10-18T16:27:52Z",
    "comment_data": [
        {
            "body": "**scoder** commented\n\nThe general problem with exceptions is two-fold:\n\n1) Cython doesn't have real frames, so it cannot just set the old exception value on function exit. There's code that keeps pointers to the original exception during try blocks, so that it can be reset afterwards. That's been in there for a while now and appears to work pretty well.\n\n2) Cython needs to support both Py2 and Py3 correctly, meaning that it must set the exception context appropriately in Py3 and set up the global exception context as expected - but without changing the semantics of exception handling for Cython code. The problem you describe above is one where Py2 and Py3 behave differently due to the exception context.\n\nI generally vote for Py3 semantics of exception raising and handling in Cython code, but we must map that to Py2.x and Py3 correctly under the hood. I've been working on the details for ages but never got around to finishing it up. Any help is appreciated.",
            "created_at": "2009-07-12T19:48:49Z",
            "html_url": "https://github.com/cython/cython/issues/908#issuecomment-240044848",
            "id": 240044848,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/908",
            "updated_at": "2016-08-16T09:00:13Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/240044848",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        },
        {
            "body": "**scoder** changed **milestone** from `wishlist` to `0.12`\ncommented\n\nsee also http://trac.cython.org/ticket/228",
            "created_at": "2009-10-11T17:23:28Z",
            "html_url": "https://github.com/cython/cython/issues/908#issuecomment-240044849",
            "id": 240044849,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/908",
            "updated_at": "2016-08-16T10:34:24Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/240044849",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        },
        {
            "body": "**scoder** changed **owner** from `somebody` to `scoder`\ncommented",
            "created_at": "2009-10-18T16:26:46Z",
            "html_url": "https://github.com/cython/cython/issues/908#issuecomment-240044850",
            "id": 240044850,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/908",
            "updated_at": "2016-08-16T09:00:13Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/240044850",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        },
        {
            "body": "**scoder** changed **resolution** to `fixed`\n**status** from `new` to `closed`\ncommented\n\nFix is implemented here:\n\nhttp://hg.cython.org/cython-devel/rev/587be39d90f9",
            "created_at": "2009-10-18T16:27:52Z",
            "html_url": "https://github.com/cython/cython/issues/908#issuecomment-240044851",
            "id": 240044851,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/908",
            "updated_at": "2016-08-16T09:00:13Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/240044851",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/908/comments",
    "created_at": "2009-07-11T02:08:32Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2016-08-16T09:00:12Z",
            "event": "labeled",
            "id": 756748922,
            "label": {
                "color": "444444",
                "name": "Code Generation"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/756748922"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2016-08-16T09:00:12Z",
            "event": "labeled",
            "id": 756748923,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/756748923"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2016-08-16T09:00:13Z",
            "event": "milestoned",
            "id": 756748925,
            "milestone": {
                "title": "0.12"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/756748925"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2009-10-18T16:27:52Z",
            "event": "closed",
            "id": 756748929,
            "url": "https://api.github.com/repos/cython/cython/issues/events/756748929"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/908/events",
    "html_url": "https://github.com/cython/cython/issues/908",
    "id": 171358524,
    "labels": [
        {
            "color": "444444",
            "name": "Code Generation",
            "url": "https://api.github.com/repos/cython/cython/labels/Code%20Generation"
        },
        {
            "color": "444444",
            "name": "defect",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/908/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": "2016-08-16T08:38:55Z",
        "closed_issues": 96,
        "created_at": "2016-08-16T08:38:55Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
            "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
            "followers_url": "https://api.github.com/users/robertwb/followers",
            "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
            "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/robertwb",
            "id": 486017,
            "login": "robertwb",
            "organizations_url": "https://api.github.com/users/robertwb/orgs",
            "received_events_url": "https://api.github.com/users/robertwb/received_events",
            "repos_url": "https://api.github.com/users/robertwb/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/robertwb"
        },
        "description": "",
        "due_on": null,
        "html_url": "https://github.com/cython/cython/milestones/0.12",
        "id": 1944449,
        "labels_url": "https://api.github.com/repos/cython/cython/milestones/13/labels",
        "number": 13,
        "open_issues": 0,
        "state": "closed",
        "title": "0.12",
        "updated_at": "2016-08-16T09:05:09Z",
        "url": "https://api.github.com/repos/cython/cython/milestones/13"
    },
    "number": 908,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "Exceptions caught and handled in Cython are \"leaked\" into Python",
    "updated_at": "2016-08-16T10:34:24Z",
    "url": "https://api.github.com/repos/cython/cython/issues/908",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/486017?v=3",
        "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
        "followers_url": "https://api.github.com/users/robertwb/followers",
        "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
        "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/robertwb",
        "id": 486017,
        "login": "robertwb",
        "organizations_url": "https://api.github.com/users/robertwb/orgs",
        "received_events_url": "https://api.github.com/users/robertwb/received_events",
        "repos_url": "https://api.github.com/users/robertwb/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/robertwb"
    }
}