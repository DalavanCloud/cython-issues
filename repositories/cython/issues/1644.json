{
    "assignee": null,
    "assignees": [],
    "body": "I want to Cython wrap a set of C++ functions that return multiple 2D std::vector arrays by passing numpy arrays to it by reference.\r\n\r\nTo illustrate this use case, below is a c++ function that returns the addition and subtraction of two 2D matrices:\r\n\r\n```c++\r\n\r\n#include <vector>\r\n\r\nvoid _plus_minus(std::vector< std::vector<long> > A,\r\n                 std::vector< std::vector<long> > B,\r\n                 std::vector< std::vector<long> > &plus,\r\n                 std::vector< std::vector<long> > &minus)\r\n{\r\n    for(int i = 0; i < A.size(); i++) {\r\n        for(int j = 0; j < A[0].size; i++) {\r\n            plus[i][j] = A[i][j] + B[i][j];\r\n            minus[i][j] = A[i][j] - B[i][j];\r\n        }\r\n    }\r\n}\r\n\r\n```\r\n\r\nBelow is a .pyx file that wraps and calls this c++ function\r\n\r\n```python\r\n\r\nimport numpy as np\r\ncimport numpy as np\r\n\r\nfrom libcpp.vector cimport vector\r\n\r\ncdef extern from \"_plus_minus.h\":\r\n    void _plus_minus(vector[vector[long]] A, vector[vector[long]] B, vector[vector[double]] &plus, vector[vector[long]] &minus)\r\n\r\ndef _plus_minus_cython(np.ndarray[np.int64_t, ndim=2, mode=\"c\"] A,\r\n                       np.ndarray[np.int64_t, ndim=2, mode=\"c\"] B):\r\n\r\n    cdef int size_y = A.shape[0]\r\n    cdef int size_x = A.shape[1]\r\n\r\n    cdef np.ndarray[np.int64_t, ndim=2, mode=\"c\"] plus = np.zeros([size_y, size_x], dtype=np.int64)\r\n    cdef np.ndarray[np.int64_t, ndim=2, mode=\"c\"] minus = np.zeros([size_y, size_x], dtype=np.int64)\r\n\r\n    _plus_minus(A, B, plus, minus)\r\n\r\n    return np.asarray(plus), np.asarray(minus)\r\n```\r\n\r\nHowever the changes made to the arrays plus and minus inside the C++ function get lost when the function returns.\r\n\r\nI could pass the output arrays as pointers to get it to work, but i would be preferable to have a way that uses std::vector instead",
    "closed_at": null,
    "comment_data": [
        {
            "body": "this seems really expensive: `std::vector` owns its data so you would need to copy the array into a vector to pass into the function, then copy the results back to the ndarray when you are done. You can just return a pair of vectors if that is what you want:\r\n\r\n```c++\r\n#include <vector>\r\n#include <utility>\r\n\r\nstd::pair<std::vector<std::vector<long>>, std::vector<std::vector<long>>>\r\n_plus_minus(const std::vector<std::vector<long>>& A,\r\n            const std::vector<std::vector<long>>& B) {\r\n    std::vector<std::vector<long>> plus;\r\n    std::vector<std::vector<long>> minus;\r\n\r\n    plus.reserve(A.size());\r\n    minus.reserve(A.size());\r\n\r\n    for(std::size_t i = 0; i < A.size(); i++) {\r\n        plus[i].reserve(A[0].size());\r\n        minus[i].reserve(A[0].size());\r\n\r\n        for(std::size_t j = 0; j < A[0].size(); i++) {\r\n            plus[i][j] = A[i][j] + B[i][j];\r\n            minus[i][j] = A[i][j] - B[i][j];\r\n        }\r\n    }\r\n\r\n    return {plus, minus};\r\n}\r\n```\r\n\r\nNote: you want to accept the input by const reference or you may copy the incoming data.",
            "created_at": "2017-03-28T00:07:21Z",
            "html_url": "https://github.com/cython/cython/issues/1644#issuecomment-289622608",
            "id": 289622608,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1644",
            "updated_at": "2017-03-28T00:07:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/289622608",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/3064397?v=3",
                "events_url": "https://api.github.com/users/llllllllll/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllllllll/followers",
                "following_url": "https://api.github.com/users/llllllllll/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllllllll/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllllllll",
                "id": 3064397,
                "login": "llllllllll",
                "organizations_url": "https://api.github.com/users/llllllllll/orgs",
                "received_events_url": "https://api.github.com/users/llllllllll/received_events",
                "repos_url": "https://api.github.com/users/llllllllll/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllllllll/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllllllll/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllllllll"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1644/comments",
    "created_at": "2017-03-27T15:54:11Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1923534?v=3",
                "events_url": "https://api.github.com/users/cdeepakroy/events{/privacy}",
                "followers_url": "https://api.github.com/users/cdeepakroy/followers",
                "following_url": "https://api.github.com/users/cdeepakroy/following{/other_user}",
                "gists_url": "https://api.github.com/users/cdeepakroy/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/cdeepakroy",
                "id": 1923534,
                "login": "cdeepakroy",
                "organizations_url": "https://api.github.com/users/cdeepakroy/orgs",
                "received_events_url": "https://api.github.com/users/cdeepakroy/received_events",
                "repos_url": "https://api.github.com/users/cdeepakroy/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/cdeepakroy/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/cdeepakroy/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/cdeepakroy"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2017-03-27T15:54:57Z",
            "event": "renamed",
            "id": 1016947473,
            "rename": {
                "from": "Support cython wrap of c++ function that return multiple std::vector arrays by passing numpy arrays a reference",
                "to": "Support cython wrap of c++ functions that return multiple std::vector arrays by passing numpy arrays a reference"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/1016947473"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1644/events",
    "html_url": "https://github.com/cython/cython/issues/1644",
    "id": 217292185,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1644/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 1644,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Support cython wrap of c++ functions that return multiple std::vector arrays by passing numpy arrays a reference",
    "updated_at": "2017-03-28T00:07:21Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1644",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/1923534?v=3",
        "events_url": "https://api.github.com/users/cdeepakroy/events{/privacy}",
        "followers_url": "https://api.github.com/users/cdeepakroy/followers",
        "following_url": "https://api.github.com/users/cdeepakroy/following{/other_user}",
        "gists_url": "https://api.github.com/users/cdeepakroy/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/cdeepakroy",
        "id": 1923534,
        "login": "cdeepakroy",
        "organizations_url": "https://api.github.com/users/cdeepakroy/orgs",
        "received_events_url": "https://api.github.com/users/cdeepakroy/received_events",
        "repos_url": "https://api.github.com/users/cdeepakroy/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/cdeepakroy/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cdeepakroy/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/cdeepakroy"
    }
}